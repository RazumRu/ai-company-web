import { Card, Typography, Space, Tag, Spin, Empty } from 'antd';
import { useEffect, useState } from 'react';
import { templatesApi } from '../../../api';
import type { TemplateDto } from '../../../autogenerated';

const { Title, Text } = Typography;

interface TemplateSidebarProps {
  onTemplateClick: (template: TemplateDto) => void;
}

export const TemplateSidebar = ({ onTemplateClick }: TemplateSidebarProps) => {
  const [templates, setTemplates] = useState<TemplateDto[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const res = await templatesApi.getAllTemplates();
        if (!mounted) return;
        setTemplates(res.data || []);
      } catch (e) {
        if (!mounted) return;
        console.error('Error fetching templates:', e);
        setError('Failed to load templates');
      } finally {
        if (mounted) setLoading(false);
      }
    })();
    return () => {
      mounted = false;
    };
  }, []);

  const onDragStart = (event: React.DragEvent, template: TemplateDto) => {
    event.dataTransfer.setData(
      'application/reactflow',
      JSON.stringify(template),
    );
    event.dataTransfer.effectAllowed = 'move';
  };

  if (loading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', padding: 24 }}>
        <Spin size="large" />
      </div>
    );
  }

  if (error) {
    return <div style={{ padding: 24, color: 'red' }}>{error}</div>;
  }

  if (templates.length === 0) {
    return (
      <div style={{ padding: 24 }}>
        <Empty description="No templates available" />
      </div>
    );
  }

  return (
    <div style={{ padding: 16, height: '100%', overflowY: 'auto' }}>
      <Title level={4} style={{ marginBottom: 16 }}>
        Templates
      </Title>
      <Space direction="vertical" style={{ width: '100%' }} size="middle">
        {templates.map((template) => (
          <Card
            key={template.name}
            size="small"
            hoverable
            draggable
            onDragStart={(e) => onDragStart(e, template)}
            onClick={() => onTemplateClick(template)}
            style={{ cursor: 'grab' }}
            styles={{ body: { padding: 12 } }}>
            <Space direction="vertical" size="small" style={{ width: '100%' }}>
              <Text strong>{template.name}</Text>
              <Tag color="blue">{template.kind}</Tag>
              <Text type="secondary" style={{ fontSize: 12 }}>
                {template.description}
              </Text>
            </Space>
          </Card>
        ))}
      </Space>
    </div>
  );
};
