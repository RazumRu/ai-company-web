import { LeftOutlined, SearchOutlined } from '@ant-design/icons';
import {
  Button,
  Card,
  Divider,
  Empty,
  Input,
  Space,
  Tag,
  Typography,
} from 'antd';
import { useMemo, useState } from 'react';

import type { TemplateDto, TemplateDtoKindEnum } from '../../../autogenerated';
import { GraphValidationService } from '../../../services/GraphValidationService';
import type { GraphNode, GraphNodeData } from '../types';

const { Title, Text } = Typography;

interface TemplateSidebarProps {
  onTemplateClick: (template: TemplateDto) => void;
  onClose: () => void;
  templates: TemplateDto[];
  selectedNode?: GraphNode;
  allNodes?: GraphNode[];
}

export const TemplateSidebar = ({
  onTemplateClick,
  onClose,
  templates,
  selectedNode,
  allNodes = [],
}: TemplateSidebarProps) => {
  const [searchText, setSearchText] = useState('');
  const [selectedKinds, setSelectedKinds] = useState<Set<TemplateDtoKindEnum>>(
    new Set(),
  );

  const onDragStart = (event: React.DragEvent, template: TemplateDto) => {
    event.dataTransfer.setData(
      'application/reactflow',
      JSON.stringify(template),
    );
    event.dataTransfer.effectAllowed = 'move';
  };

  // Get all unique kinds from templates
  const availableKinds = useMemo(() => {
    const kinds = new Set<TemplateDtoKindEnum>();
    templates.forEach((template) => {
      if (template.kind) {
        kinds.add(template.kind);
      }
    });
    return Array.from(kinds).sort();
  }, [templates]);

  // Filter templates based on search text and selected kinds
  const filteredTemplates = useMemo(() => {
    return templates.filter((template) => {
      // Filter by search text
      const matchesSearch =
        !searchText ||
        template.name?.toLowerCase().includes(searchText.toLowerCase()) ||
        template.description
          ?.toLowerCase()
          .includes(searchText.toLowerCase()) ||
        template.kind?.toLowerCase().includes(searchText.toLowerCase());

      // Filter by selected kinds
      const matchesKind =
        selectedKinds.size === 0 ||
        (template.kind && selectedKinds.has(template.kind));

      return matchesSearch && matchesKind;
    });
  }, [templates, searchText, selectedKinds]);

  const toggleKindFilter = (kind: TemplateDtoKindEnum) => {
    const newSelectedKinds = new Set(selectedKinds);
    if (newSelectedKinds.has(kind)) {
      newSelectedKinds.delete(kind);
    } else {
      newSelectedKinds.add(kind);
    }
    setSelectedKinds(newSelectedKinds);
  };

  if (templates.length === 0) {
    return (
      <div style={{ padding: 24 }}>
        <Empty description="No templates available" />
      </div>
    );
  }

  const getGraphNodeData = (node?: GraphNode): GraphNodeData | undefined => {
    if (!node) return undefined;
    return node.data as unknown as GraphNodeData;
  };

  const selectedNodeData = getGraphNodeData(selectedNode);

  // Get available input types for selected node
  const getAvailableInputTypesForSelectedNode = () => {
    if (!selectedNode || !selectedNodeData?.template) return [];

    const nodeTemplate = templates.find(
      (t) => t.id === selectedNodeData.template,
    );
    if (!nodeTemplate || !nodeTemplate.inputs) return [];

    return GraphValidationService.getAvailableConnectionTypes(
      selectedNode,
      templates,
    );
  };

  // Get required connections for selected node
  const getRequiredConnectionsForSelectedNode = () => {
    if (!selectedNode || !selectedNodeData?.template) return [];

    return GraphValidationService.getRequiredConnections(
      selectedNode,
      templates,
    );
  };

  // Check if a required connection is satisfied
  const isRequiredConnectionSatisfied = (connection: {
    type: string;
    value: unknown;
  }): boolean => {
    if (!selectedNode || !allNodes) return false;

    // Check if there are any edges that satisfy this required connection
    return allNodes.some((node) => {
      const nodeData = getGraphNodeData(node);
      if (!nodeData) return false;

      const nodeTemplate = templates.find((t) => t.id === nodeData.template);
      if (!nodeTemplate) return false;

      if (connection.type === 'kind') {
        return nodeTemplate.kind === connection.value;
      } else if (connection.type === 'template') {
        return nodeTemplate.id === connection.value;
      }
      return false;
    });
  };

  const availableInputTypes = getAvailableInputTypesForSelectedNode();
  const requiredConnections = getRequiredConnectionsForSelectedNode();
  const isAllRequiredConnected = requiredConnections.every(
    isRequiredConnectionSatisfied,
  );

  return (
    <div style={{ padding: 16, height: '100%', overflowY: 'auto' }}>
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          marginBottom: 16,
        }}>
        <Title level={4} style={{ margin: 0 }}>
          Templates
        </Title>
        <Button
          type="default"
          shape="circle"
          size="small"
          icon={<LeftOutlined />}
          onClick={onClose}
          aria-label="Collapse template sidebar"
          style={{
            minWidth: 32,
            width: 32,
            height: 32,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            border: 'none',
            boxShadow: 'none',
          }}
        />
      </div>

      <div style={{ marginBottom: 16 }}>
        <Input
          placeholder="Search templates..."
          prefix={<SearchOutlined />}
          value={searchText}
          onChange={(e) => setSearchText(e.target.value)}
        />
        {availableKinds.length > 0 && (
          <div
            style={{
              marginTop: 5,
              display: 'flex',
              flexWrap: 'wrap',
              gap: 5,
            }}>
            {availableKinds.map((kind) => {
              const isActive = selectedKinds.has(kind);
              return (
                <Tag
                  key={kind}
                  color={isActive ? 'blue' : 'default'}
                  onClick={() => toggleKindFilter(kind)}
                  style={{
                    cursor: 'pointer',
                    userSelect: 'none',
                    padding: '2px 8px',
                    fontSize: 11,
                    margin: 0,
                  }}>
                  {kind}
                </Tag>
              );
            })}
          </div>
        )}
        <Text type="secondary" style={{ fontSize: 12 }}>
          Available results: {filteredTemplates.length}
        </Text>
      </div>

      {selectedNode && requiredConnections.length > 0 && (
        <>
          <div style={{ marginBottom: 16 }}>
            <Text
              type="secondary"
              style={{
                fontSize: 12,
                color: isAllRequiredConnected ? '#52c41a' : '#ff4d4f',
                fontWeight: 'bold',
              }}>
              Required connections for "{selectedNodeData?.label || 'Node'}":
            </Text>
            <Space
              direction="vertical"
              style={{ width: '100%', marginTop: 8 }}
              size="small">
              {requiredConnections.map((connection, index) => {
                const isSatisfied = isRequiredConnectionSatisfied(connection);
                const isRed = !isSatisfied;

                return (
                  <Card
                    key={`required-${index}`}
                    size="small"
                    style={{
                      border: isRed ? '2px solid #ff4d4f' : '2px solid #52c41a',
                      background: isRed ? '#fff2f0' : '#f6ffed',
                    }}
                    styles={{ body: { padding: 8 } }}>
                    <Space
                      direction="vertical"
                      size="small"
                      style={{ width: '100%' }}>
                      <div
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 4,
                        }}>
                        <Text
                          strong
                          style={{
                            fontSize: 12,
                            color: isRed ? '#ff4d4f' : '#52c41a',
                          }}>
                          {connection.type}: {connection.value}
                        </Text>
                        <Tag
                          color={isRed ? 'red' : 'green'}
                          style={{ fontSize: 10 }}>
                          {isRed ? 'REQUIRED' : 'CONNECTED'}
                        </Tag>
                      </div>
                      <Text type="secondary" style={{ fontSize: 11 }}>
                        {isRed
                          ? 'This connection is mandatory for the node to function properly'
                          : 'This required connection is satisfied'}
                      </Text>
                    </Space>
                  </Card>
                );
              })}
            </Space>
          </div>
          <Divider style={{ margin: '16px 0' }} />
        </>
      )}

      {selectedNode && (
        <>
          <div style={{ marginBottom: 16 }}>
            <Text type="secondary" style={{ fontSize: 12 }}>
              Available inputs:
            </Text>
            {availableInputTypes.length > 0 ? (
              <div
                style={{
                  marginTop: 8,
                  display: 'flex',
                  gap: 12,
                  flexDirection: 'column',
                }}>
                {availableInputTypes.map((inputType, index) => (
                  <Card
                    key={`input-${index}`}
                    size="small"
                    style={{
                      border: '1px solid #1890ff',
                      background: '#f0f8ff',
                    }}
                    styles={{ body: { padding: 8 } }}>
                    <Space
                      direction="vertical"
                      size="small"
                      style={{ width: '100%' }}>
                      <div
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 4,
                          flexWrap: 'wrap',
                        }}>
                        <Text strong style={{ fontSize: 12 }}>
                          {inputType.type}: {inputType.value}
                        </Text>
                        {inputType.required && (
                          <Tag color="red" style={{ fontSize: 10 }}>
                            Required
                          </Tag>
                        )}
                        {inputType.multiple && (
                          <Tag color="orange" style={{ fontSize: 10 }}>
                            Multiple
                          </Tag>
                        )}
                      </div>
                      <Text type="secondary" style={{ fontSize: 11 }}>
                        This input type can accept connections from:
                      </Text>
                      <div
                        style={{
                          display: 'flex',
                          gap: 8,
                          flexWrap: 'wrap',
                          justifyContent: 'flex-start',
                        }}>
                        {inputType.availableTemplates.map((template) => (
                          <Tag
                            key={template.id}
                            color="blue"
                            style={{ fontSize: 10, margin: 0 }}>
                            {template.name}
                          </Tag>
                        ))}
                      </div>
                    </Space>
                  </Card>
                ))}
              </div>
            ) : (
              <div
                style={{
                  marginTop: 8,
                  padding: 12,
                  background: '#f5f5f5',
                  borderRadius: 4,
                  border: '1px solid #d9d9d9',
                }}>
                <Text
                  type="secondary"
                  style={{ fontSize: 12, color: '#8c8c8c' }}>
                  No available inputs for this node
                </Text>
              </div>
            )}
          </div>
          <Divider style={{ margin: '16px 0' }} />
        </>
      )}

      <Space direction="vertical" style={{ width: '100%' }} size="middle">
        {filteredTemplates.length === 0 ? (
          <Empty
            description={
              searchText || selectedKinds.size > 0
                ? 'No templates match your filters'
                : 'No templates available'
            }
            style={{ marginTop: 24 }}
          />
        ) : (
          filteredTemplates.map((template) => (
            <Card
              key={template.id}
              size="small"
              hoverable
              draggable
              onDragStart={(e) => onDragStart(e, template)}
              onClick={() => onTemplateClick(template)}
              style={{ cursor: 'grab' }}
              styles={{ body: { padding: 12 } }}>
              <Space
                direction="vertical"
                size="small"
                style={{ width: '100%' }}>
                <Text strong>{template.name}</Text>
                <Tag color="blue">{template.kind}</Tag>
                <Text type="secondary" style={{ fontSize: 12 }}>
                  {template.description}
                </Text>
              </Space>
            </Card>
          ))
        )}
      </Space>
    </div>
  );
};
