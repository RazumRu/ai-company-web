import {
  LeftOutlined,
  QuestionCircleOutlined,
  RightOutlined,
  SearchOutlined,
  UpOutlined,
} from '@ant-design/icons';
import { Button, Empty, Input, Tag, Typography } from 'antd';
import { useMemo, useState } from 'react';

import type { TemplateDto } from '../../../autogenerated';
import type { GraphNode } from '../types';

const { Title, Text } = Typography;

interface TemplateSidebarProps {
  onTemplateClick: (template: TemplateDto) => void;
  onClose: () => void;
  templates: TemplateDto[];
  selectedNode?: GraphNode;
  allNodes?: GraphNode[];
}

export const TemplateSidebar = ({
  onTemplateClick,
  onClose,
  templates,
  selectedNode: _selectedNode,
  allNodes: _allNodes = [],
}: TemplateSidebarProps) => {
  const [searchText, setSearchText] = useState('');
  const [expandedKinds, setExpandedKinds] = useState<Set<string>>(
    () => new Set(),
  );

  const onDragStart = (event: React.DragEvent, template: TemplateDto) => {
    event.dataTransfer.setData(
      'application/reactflow',
      JSON.stringify(template),
    );
    event.dataTransfer.effectAllowed = 'move';
  };

  // Filter templates based on search text
  const filteredTemplates = useMemo(() => {
    return templates.filter((template) => {
      const matchesSearch =
        !searchText ||
        template.name?.toLowerCase().includes(searchText.toLowerCase()) ||
        template.description
          ?.toLowerCase()
          .includes(searchText.toLowerCase()) ||
        template.kind?.toLowerCase().includes(searchText.toLowerCase());
      return matchesSearch;
    });
  }, [templates, searchText]);

  const groupedTemplates = useMemo(() => {
    const groups = new Map<string, TemplateDto[]>();

    filteredTemplates.forEach((template) => {
      const kind = String(template.kind ?? 'Other');
      const group = groups.get(kind) ?? [];
      group.push(template);
      groups.set(kind, group);
    });

    return Array.from(groups.entries()).sort(([a], [b]) => a.localeCompare(b));
  }, [filteredTemplates]);

  if (templates.length === 0) {
    return (
      <div style={{ padding: 24 }}>
        <Empty description="No templates available" />
      </div>
    );
  }

  const getKindColor = (kind: string) => {
    const normalized = kind.toLowerCase();
    switch (normalized) {
      case 'knowledge':
        return '#8e63ff';
      case 'mcp':
        return '#3d6cff';
      case 'resource':
        return '#25b5ae';
      case 'runtime':
        return '#ff8a34';
      case 'simpleagent':
        return '#6cc36c';
      case 'tool':
        return '#4c8dff';
      case 'trigger':
        return '#ffb020';
      default:
        return '#d9d9d9';
    }
  };

  const formatKindLabel = (kind: string) => {
    const normalized = kind.toLowerCase();
    switch (normalized) {
      case 'simpleagent':
        return 'Agent';
      case 'tool':
        return 'Tools';
      case 'trigger':
        return 'Triggers';
      case 'mcp':
        return 'MCP';
      case 'resource':
        return 'Resource';
      case 'runtime':
        return 'Runtime';
      case 'knowledge':
        return 'Knowledge';
      default:
        return kind;
    }
  };

  const toggleKindExpanded = (kind: string) => {
    setExpandedKinds((prev) => {
      const next = new Set(prev);
      if (next.has(kind)) {
        next.delete(kind);
      } else {
        next.add(kind);
      }
      return next;
    });
  };

  return (
    <div
      style={{
        height: '100%',
        overflowY: 'auto',
        background: '#f6f6f6',
      }}>
      <div
        style={{
          background: 'white',
          padding: 16,
        }}>
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            marginBottom: 16,
          }}>
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: 10,
            }}>
            <Title level={4} style={{ margin: 0 }}>
              Templates
            </Title>
            <span
              style={{
                fontSize: 10,
                padding: '1px 8px',
                borderRadius: 999,
                background: '#f2f2f2',
                color: '#595959',
                position: 'relative',
                top: '1px',
              }}>
              {templates.length}
            </span>
          </div>
          <Button
            type="default"
            shape="circle"
            size="small"
            icon={<LeftOutlined />}
            onClick={onClose}
            aria-label="Collapse template sidebar"
            style={{
              minWidth: 32,
              width: 32,
              height: 32,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              border: 'none',
              boxShadow: 'none',
            }}
          />
        </div>

        <div>
          <Input
            placeholder="Search templates..."
            prefix={<SearchOutlined />}
            value={searchText}
            onChange={(e) => setSearchText(e.target.value)}
          />
          <div>
            <Text type="secondary" style={{ fontSize: 12 }}>
              Available results: {filteredTemplates.length}
            </Text>
          </div>
        </div>
      </div>

      <div style={{ width: '100%', padding: '16px' }}>
        {filteredTemplates.length === 0 ? (
          <Empty
            description={
              searchText
                ? 'No templates match your search'
                : 'No templates available'
            }
            style={{ marginTop: 24 }}
          />
        ) : (
          <>
            <Text style={{ fontSize: 14, color: '#595959' }}>Categories</Text>
            <div
              style={{
                display: 'flex',
                flexDirection: 'column',
                gap: 6,
                marginTop: '10px',
              }}>
              {groupedTemplates.map(([kind, kindTemplates]) => {
                const isExpanded = expandedKinds.has(kind);
                const kindColor = getKindColor(kind);
                const kindLabel = formatKindLabel(kind);

                return (
                  <div key={kind}>
                    <div
                      role="button"
                      tabIndex={0}
                      onClick={() => toggleKindExpanded(kind)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                          e.preventDefault();
                          toggleKindExpanded(kind);
                        }
                      }}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        gap: 12,
                        padding: '10px 12px',
                        borderRadius: 10,
                        background: '#fff',
                        cursor: 'pointer',
                        userSelect: 'none',
                      }}>
                      <div
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 7,
                        }}>
                        <span
                          aria-hidden
                          style={{
                            width: 7,
                            height: 7,
                            borderRadius: 999,
                            background: kindColor,
                            display: 'inline-block',
                          }}
                        />
                        <Text strong style={{ fontSize: 14 }}>
                          {kindLabel}
                        </Text>
                        <Text type="secondary" style={{ fontSize: 11 }}>
                          {kindTemplates.length}
                        </Text>
                      </div>
                      <Button
                        type="text"
                        size="small"
                        icon={
                          isExpanded ? (
                            <UpOutlined
                              style={{ fontSize: 12, color: '#8c8c8c' }}
                            />
                          ) : (
                            <RightOutlined
                              style={{ fontSize: 12, color: '#8c8c8c' }}
                            />
                          )
                        }
                        aria-label={
                          isExpanded ? `Collapse ${kind}` : `Expand ${kind}`
                        }
                        onClick={(e) => {
                          e.stopPropagation();
                          toggleKindExpanded(kind);
                        }}
                        style={{
                          width: 24,
                          height: 24,
                          minWidth: 24,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          padding: 0,
                          opacity: 0.8,
                        }}
                      />
                    </div>

                    {isExpanded && (
                      <div
                        style={{
                          marginTop: 6,
                          display: 'flex',
                          flexDirection: 'column',
                          gap: 6,
                        }}>
                        {kindTemplates.map((template) => (
                          <div
                            key={template.id}
                            draggable
                            onDragStart={(e) => onDragStart(e, template)}
                            style={{
                              padding: 12,
                              borderRadius: 12,
                              background: '#fff',
                              cursor: 'grab',
                            }}>
                            <div
                              style={{
                                display: 'flex',
                                alignItems: 'flex-start',
                                justifyContent: 'space-between',
                                gap: 12,
                              }}>
                              <div style={{ minWidth: 0, flex: 1 }}>
                                <Text
                                  strong
                                  style={{
                                    fontSize: 14,
                                    display: 'block',
                                    whiteSpace: 'nowrap',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                  }}>
                                  {template.name}
                                </Text>
                                <Text
                                  type="secondary"
                                  style={{
                                    fontSize: 13,
                                    marginTop: 4,
                                    display: 'block',
                                  }}>
                                  {template.description}
                                </Text>
                                <div style={{ marginTop: 8 }}>
                                  <Tag
                                    color={kindColor}
                                    style={{
                                      margin: 0,
                                      border: 'none',
                                      color: '#fff',
                                      fontSize: 12,
                                    }}>
                                    {String(template.kind)}
                                  </Tag>
                                </div>
                              </div>
                              <Button
                                type="text"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  onTemplateClick(template);
                                }}
                                icon={
                                  <QuestionCircleOutlined
                                    style={{ fontSize: 14, color: '#8c8c8c' }}
                                  />
                                }
                                style={{
                                  borderRadius: 10,
                                  width: 20,
                                  height: 20,
                                  padding: 0,
                                }}></Button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </>
        )}
      </div>
    </div>
  );
};
