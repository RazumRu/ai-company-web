import {
  BarChartOutlined,
  HistoryOutlined,
  LoadingOutlined,
} from '@ant-design/icons';
import {
  Button,
  Card,
  Divider,
  Space,
  Statistic,
  Table,
  Tag,
  Tooltip,
  Typography,
} from 'antd';
import type { ColumnsType } from 'antd/es/table';
import React from 'react';

import { ThreadUsageStatisticsDto } from '../../../autogenerated';

const { Text } = Typography;

interface ThreadUsageDisplayProps {
  usage: ThreadUsageStatisticsDto | null;
  loading: boolean;
  error: string | null;
  nodeDisplayNames?: Record<string, string>;
  nodeKinds?: Record<string, string>;
  localEventsCount?: number;
  onShowLocalEvents?: () => void;
}

const formatNumber = (num?: number | null): string => {
  if (typeof num !== 'number' || !Number.isFinite(num)) return '—';
  return new Intl.NumberFormat('en-US').format(num);
};

const formatUsd = (amount?: number | null): string => {
  if (typeof amount !== 'number' || !Number.isFinite(amount)) return '$—';
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 4,
    maximumFractionDigits: 4,
  }).format(amount);
};

export const ThreadUsageDisplay: React.FC<ThreadUsageDisplayProps> = ({
  usage,
  loading,
  error,
  nodeDisplayNames = {},
  nodeKinds = {},
  localEventsCount,
  onShowLocalEvents,
}) => {
  if (loading) {
    return (
      <Card size="small" style={{ marginTop: 8 }}>
        <Space>
          <LoadingOutlined spin />
          <Text type="secondary">Loading usage statistics...</Text>
        </Space>
      </Card>
    );
  }

  if (error) {
    return (
      <Card size="small" style={{ marginTop: 8 }}>
        <Text type="danger">{error}</Text>
      </Card>
    );
  }

  if (!usage) {
    return null;
  }

  const { total, requests, byNode, byTool, toolsAggregate, userMessageCount } =
    usage;

  // Prepare byNode data
  const byNodeData = byNode
    ? Object.entries(byNode).map(([nodeId, stats]) => ({
        nodeId,
        nodeName: nodeDisplayNames[nodeId] || nodeId,
        nodeKind: nodeKinds[nodeId] || 'Node',
        ...stats,
      }))
    : [];

  // Check if any tool has subCalls so we can enable tree expansion
  const anyToolHasSubCalls = byTool?.some(
    (t) => t.subCalls && t.subCalls.length > 0,
  );

  // Check if any tool-level execution cost exists (toolTokens / toolPrice)
  const anyToolHasOwnCost = byTool?.some(
    (t) =>
      (typeof t.toolTokens === 'number' && t.toolTokens > 0) ||
      (typeof t.toolPrice === 'number' && t.toolPrice > 0),
  );

  const toolColumns: ColumnsType<(typeof byTool)[0]> = [
    {
      title: 'Tool Name',
      dataIndex: 'toolName',
      key: 'toolName',
      ellipsis: true,
    },
    {
      title: 'Call Count',
      dataIndex: 'callCount',
      key: 'callCount',
      render: formatNumber,
      align: 'right',
    },
    {
      title: 'LLM Tokens',
      dataIndex: 'totalTokens',
      key: 'totalTokens',
      render: formatNumber,
      align: 'right',
    },
    {
      title: 'LLM Price',
      dataIndex: 'totalPrice',
      key: 'totalPrice',
      render: formatUsd,
      align: 'right',
    },
    ...(anyToolHasOwnCost
      ? [
          {
            title: 'Tool Tokens',
            dataIndex: 'toolTokens' as const,
            key: 'toolTokens',
            render: (value: number | undefined) =>
              typeof value === 'number' && value > 0
                ? formatNumber(value)
                : '-',
            align: 'right' as const,
          },
          {
            title: 'Tool Price',
            dataIndex: 'toolPrice' as const,
            key: 'toolPrice',
            render: (value: number | undefined) =>
              typeof value === 'number' && value > 0 ? formatUsd(value) : '-',
            align: 'right' as const,
          },
        ]
      : []),
  ];

  const hasLocalEvents =
    typeof localEventsCount === 'number' && localEventsCount > 0;

  const localEventsButton =
    hasLocalEvents && onShowLocalEvents ? (
      <Tooltip title={`View ${localEventsCount} socket events`}>
        <Button
          size="small"
          type="text"
          icon={<HistoryOutlined />}
          onClick={onShowLocalEvents}
        />
      </Tooltip>
    ) : null;

  return (
    <Card
      size="small"
      title={
        <Space>
          <BarChartOutlined />
          <Text strong>Thread Usage Statistics</Text>
        </Space>
      }
      extra={localEventsButton}
      style={{ marginTop: 8 }}>
      {/* Total Statistics */}
      <div style={{ marginBottom: 16 }}>
        <Text
          strong
          style={{ fontSize: 13, display: 'block', marginBottom: 8 }}>
          Total Usage
        </Text>
        <Space size="large" wrap>
          {typeof requests === 'number' && (
            <Statistic
              title="Requests"
              value={formatNumber(requests)}
              valueStyle={{ fontSize: 16 }}
            />
          )}
          {typeof userMessageCount === 'number' && (
            <Statistic
              title="User Messages"
              value={formatNumber(userMessageCount)}
              valueStyle={{ fontSize: 16 }}
            />
          )}
          <Statistic
            title="Total Tokens"
            value={formatNumber(total.totalTokens)}
            valueStyle={{ fontSize: 16 }}
          />
          <Statistic
            title="Input Tokens"
            value={formatNumber(total.inputTokens)}
            valueStyle={{ fontSize: 16 }}
          />
          {typeof total.cachedInputTokens === 'number' && (
            <Statistic
              title="Cached Input"
              value={formatNumber(total.cachedInputTokens)}
              valueStyle={{ fontSize: 16 }}
            />
          )}
          <Statistic
            title="Output Tokens"
            value={formatNumber(total.outputTokens)}
            valueStyle={{ fontSize: 16 }}
          />
          {typeof total.reasoningTokens === 'number' && (
            <Statistic
              title="Reasoning"
              value={formatNumber(total.reasoningTokens)}
              valueStyle={{ fontSize: 16 }}
            />
          )}
          {typeof total.totalPrice === 'number' && (
            <Statistic
              title="Total Cost"
              value={formatUsd(total.totalPrice)}
              valueStyle={{ fontSize: 16 }}
            />
          )}
          {typeof total.currentContext === 'number' && (
            <Statistic
              title="Current Context"
              value={formatNumber(total.currentContext)}
              valueStyle={{ fontSize: 16 }}
            />
          )}
        </Space>
      </div>

      <Divider style={{ margin: '12px 0' }} />

      {/* Tools Aggregate */}
      {toolsAggregate && (
        <>
          <div style={{ marginBottom: 16 }}>
            <Text
              strong
              style={{ fontSize: 13, display: 'block', marginBottom: 8 }}>
              Tools Aggregate
            </Text>
            <Space size="middle" wrap>
              <Statistic
                title="Requests"
                value={formatNumber(toolsAggregate.requestCount)}
                valueStyle={{ fontSize: 14 }}
              />
              <Statistic
                title="Tokens"
                value={formatNumber(toolsAggregate.totalTokens)}
                valueStyle={{ fontSize: 14 }}
              />
              {typeof toolsAggregate.totalPrice === 'number' && (
                <Statistic
                  title="Cost"
                  value={formatUsd(toolsAggregate.totalPrice)}
                  valueStyle={{ fontSize: 14 }}
                />
              )}
            </Space>
          </div>
          <Divider style={{ margin: '12px 0' }} />
        </>
      )}

      {/* Usage by Agent - Always expanded, as table */}
      {byNodeData.length > 0 && (
        <div style={{ marginBottom: 16 }}>
          <Text
            strong
            style={{ fontSize: 13, display: 'block', marginBottom: 12 }}>
            Usage by Agent ({byNodeData.length})
          </Text>
          <Table
            dataSource={byNodeData}
            columns={[
              {
                title: 'Agent',
                dataIndex: 'nodeName',
                key: 'nodeName',
                render: (name: string, record: (typeof byNodeData)[0]) => (
                  <div>
                    <div
                      style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                      <Text strong>{name}</Text>
                      <Tag
                        style={{
                          fontSize: 10,
                          lineHeight: '16px',
                          padding: '0 6px',
                          margin: 0,
                        }}>
                        {record.nodeKind}
                      </Tag>
                    </div>
                    {record.nodeName !== record.nodeId && (
                      <Text type="secondary" style={{ fontSize: 11 }}>
                        {record.nodeId}
                      </Text>
                    )}
                  </div>
                ),
              },
              {
                title: 'Total Tokens',
                dataIndex: 'totalTokens',
                key: 'totalTokens',
                render: formatNumber,
                align: 'right' as const,
              },
              {
                title: 'Input',
                dataIndex: 'inputTokens',
                key: 'inputTokens',
                render: formatNumber,
                align: 'right' as const,
              },
              {
                title: 'Output',
                dataIndex: 'outputTokens',
                key: 'outputTokens',
                render: formatNumber,
                align: 'right' as const,
              },
              {
                title: 'Cached',
                dataIndex: 'cachedInputTokens',
                key: 'cachedInputTokens',
                render: (value: number | undefined) =>
                  typeof value === 'number' && value > 0
                    ? formatNumber(value)
                    : '-',
                align: 'right' as const,
              },
              {
                title: 'Reasoning',
                dataIndex: 'reasoningTokens',
                key: 'reasoningTokens',
                render: (value: number | undefined) =>
                  typeof value === 'number' && value > 0
                    ? formatNumber(value)
                    : '-',
                align: 'right' as const,
              },
              {
                title: 'Total Price',
                dataIndex: 'totalPrice',
                key: 'totalPrice',
                render: formatUsd,
                align: 'right' as const,
              },
            ]}
            pagination={false}
            size="small"
            scroll={{ x: 'max-content' }}
            rowKey="nodeId"
          />
        </div>
      )}

      {/* Usage by Tool — expandable when tools have subCalls */}
      {byTool && byTool.length > 0 && (
        <>
          <Divider style={{ margin: '12px 0' }} />
          <div style={{ marginBottom: 16 }}>
            <Text
              strong
              style={{ fontSize: 13, display: 'block', marginBottom: 12 }}>
              Usage by Tool ({byTool.length})
            </Text>
            <Table
              dataSource={byTool}
              columns={toolColumns}
              pagination={false}
              size="small"
              scroll={{ x: 'max-content' }}
              rowKey={(record, index) => `${record.toolName}-${index ?? 0}`}
              {...(anyToolHasSubCalls
                ? {
                    childrenColumnName: 'subCalls',
                    defaultExpandAllRows: true,
                    indentSize: 20,
                  }
                : {})}
            />
          </div>
        </>
      )}
    </Card>
  );
};
