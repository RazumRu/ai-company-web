import React from 'react';

import type { ThreadMessageDto } from '../../../../autogenerated';
import { MarkdownContent } from '../../../../components/markdown/MarkdownContent';
import { STREAMING_REASONING_FLAG } from '../../../../utils/threadMessages';
import { formatMessageContent, limitConsecutiveNewlines } from './messageUtils';

interface InlineReasoningMessageProps {
  message: ThreadMessageDto;
}

/**
 * Lightweight reasoning bubble for use inside communication / subagent blocks.
 *
 * While the message is still streaming it renders the content as plain text
 * (whiteSpace: pre-wrap) so that appended chunks only grow the element without
 * causing Markdown re-parses that shift the layout.  Once streaming ends the
 * final content is rendered through MarkdownContent for proper formatting.
 */
export const InlineReasoningMessage: React.FC<InlineReasoningMessageProps> = ({
  message,
}) => {
  const content = limitConsecutiveNewlines(
    formatMessageContent(message.message?.content),
  );

  const additionalKwargs = (message.message?.additionalKwargs ?? {}) as Record<
    string,
    unknown
  >;
  const isStreaming = Boolean(additionalKwargs?.[STREAMING_REASONING_FLAG]);

  return (
    <div
      style={{
        padding: '6px 10px',
        backgroundColor: '#fafafa',
        borderRadius: 6,
        border: '1px solid #f0f0f0',
      }}>
      {isStreaming ? (
        <div
          className="reasoning-message_streaming"
          style={{
            fontSize: '13px',
            lineHeight: '1.4',
            color: '#666',
            whiteSpace: 'pre-wrap',
            wordBreak: 'break-word',
          }}>
          {content}
        </div>
      ) : (
        <MarkdownContent
          content={content}
          style={{ fontSize: '13px', lineHeight: '1.4', color: '#666' }}
        />
      )}
      <div
        style={{
          marginTop: 4,
          fontSize: 11,
          color: '#b0b0b0',
          fontStyle: 'italic',
        }}>
        {isStreaming ? 'reasoningâ€¦' : 'reasoning'}
      </div>
    </div>
  );
};
