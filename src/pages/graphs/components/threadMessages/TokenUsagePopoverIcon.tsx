import { BarChartOutlined } from '@ant-design/icons';
import { Popover, Space, Typography } from 'antd';
import React from 'react';

import type { ThreadMessageDtoRequestTokenUsage } from '../../../../autogenerated';
import {
  formatRequestTokenCount,
  formatRequestUsdShort,
  formatTokenCount,
} from './threadMessagesViewUtils';

const { Text } = Typography;

interface TokenUsagePopoverIconProps {
  requestTokenUsage?: ThreadMessageDtoRequestTokenUsage | null;
  requestTokenUsageIn?: ThreadMessageDtoRequestTokenUsage | null;
  requestTokenUsageOut?: ThreadMessageDtoRequestTokenUsage | null;
}

export const TokenUsagePopoverIcon: React.FC<TokenUsagePopoverIconProps> = ({
  requestTokenUsage,
  requestTokenUsageIn,
  requestTokenUsageOut,
}) => {
  const effectiveRequestTokenUsageIn = requestTokenUsageIn || requestTokenUsage;

  if (!effectiveRequestTokenUsageIn && !requestTokenUsageOut) {
    return null;
  }

  const renderRequestTokenUsageSection = (
    usage: ThreadMessageDtoRequestTokenUsage,
    label: string,
  ) => (
    <>
      <Text type="secondary" style={{ fontSize: 12, fontWeight: 600 }}>
        {label}
      </Text>
      <Text type="secondary" style={{ fontSize: 12 }}>
        Total: {formatRequestTokenCount(usage.totalTokens)} (
        {formatRequestUsdShort(usage.totalPrice)})
      </Text>
      <Text type="secondary" style={{ fontSize: 12 }}>
        Input tokens: {formatTokenCount(usage.inputTokens)}
      </Text>
      {typeof usage.cachedInputTokens === 'number' && (
        <Text type="secondary" style={{ fontSize: 12 }}>
          Cached input tokens: {formatTokenCount(usage.cachedInputTokens)}
        </Text>
      )}
      <Text type="secondary" style={{ fontSize: 12 }}>
        Output tokens: {formatTokenCount(usage.outputTokens)}
      </Text>
      {typeof usage.reasoningTokens === 'number' && (
        <Text type="secondary" style={{ fontSize: 12 }}>
          Reasoning tokens: {formatTokenCount(usage.reasoningTokens)}
        </Text>
      )}
      {typeof usage.currentContext === 'number' && (
        <Text type="secondary" style={{ fontSize: 12 }}>
          Current context: {formatTokenCount(usage.currentContext)}
        </Text>
      )}
    </>
  );

  const popoverContent = (
    <Space direction="vertical" size={4} style={{ maxWidth: 340 }}>
      {effectiveRequestTokenUsageIn &&
        renderRequestTokenUsageSection(
          effectiveRequestTokenUsageIn,
          'Request Token Usage (Input):',
        )}

      {requestTokenUsageOut &&
        renderRequestTokenUsageSection(
          requestTokenUsageOut,
          'Request Token Usage (Output):',
        )}
    </Space>
  );

  return (
    <Popover
      content={popoverContent}
      trigger={['hover']}
      placement="bottomLeft">
      <span
        style={{
          display: 'inline-flex',
          alignItems: 'center',
          cursor: 'help',
        }}
        aria-label="View token usage details"
        title="View token usage details">
        <BarChartOutlined style={{ fontSize: 12 }} />
      </span>
    </Popover>
  );
};
