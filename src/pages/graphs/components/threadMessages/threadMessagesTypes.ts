import type { JsonValue } from 'type-fest';

import type {
  ThreadMessageDto,
  ThreadMessageDtoRequestTokenUsage,
} from '../../../../autogenerated';

export interface ToolCallFunction {
  name?: string;
  arguments?: string | Record<string, unknown>;
  title?: string;
  __title?: string;
}

export interface ToolCall {
  id?: string;
  name?: string;
  function?: ToolCallFunction;
  args?: string | Record<string, unknown>;
  title?: string;
  __title?: string;
}

export interface ShellResult {
  command?: string;
  exitCode?: number;
  output?: string;
  stdout?: string;
  stderr?: string;
  [key: string]: unknown;
}

export type MessagePayload = ThreadMessageDto['message'];

export type ToolRenderStatus = 'calling' | 'executed' | 'stopped';

export interface SubagentStatistics {
  usage?: {
    inputTokens?: number;
    totalTokens?: number;
    outputTokens?: number;
    currentContext?: number;
    totalPrice?: number;
  };
  toolCallsMade?: number;
  totalIterations?: number;
  totalPrice?: number;
}

export type PreparedMessage =
  | {
      type: 'system';
      message: ThreadMessageDto;
      id: string;
      nodeId?: string;
      createdAt?: string;
      inCommunicationExec?: boolean;
      sourceAgentNodeId?: string;
    }
  | {
      type: 'reasoning';
      message: ThreadMessageDto;
      id: string;
      nodeId?: string;
      createdAt?: string;
      inCommunicationExec?: boolean;
      sourceAgentNodeId?: string;
    }
  | {
      type: 'chat';
      message: ThreadMessageDto;
      id: string;
      nodeId?: string;
      createdAt?: string;
      inCommunicationExec?: boolean;
      sourceAgentNodeId?: string;
      /** When true this chat message is the AI text content of a message that
       *  also contains tool calls â€” it should be rendered inside the working
       *  block rather than as a standalone bubble. */
      isToolCallContent?: boolean;
    }
  | {
      type: 'tool';
      name: string;
      status: ToolRenderStatus;
      result?: unknown;
      id: string;
      toolKind?: 'generic' | 'shell';
      shellCommand?: string;
      toolOptions?: Record<string, JsonValue>;
      requestTokenUsage?: ThreadMessageDtoRequestTokenUsage | null;
      requestTokenUsageIn?: ThreadMessageDtoRequestTokenUsage | null;
      requestTokenUsageOut?: ThreadMessageDtoRequestTokenUsage | null;
      nodeId?: string;
      createdAt?: string;
      roleLabel?: string;
      title?: string;
      inCommunicationExec?: boolean;
      sourceAgentNodeId?: string;
    }
  | {
      type: 'subagent';
      toolCallId: string;
      purpose?: string;
      taskDescription?: string;
      agentId?: string;
      innerMessages: PreparedMessage[];
      statistics?: SubagentStatistics;
      resultText?: string;
      errorText?: string;
      model?: string;
      status: ToolRenderStatus;
      id: string;
      nodeId?: string;
      createdAt?: string;
      inCommunicationExec?: boolean;
      sourceAgentNodeId?: string;
    }
  | {
      type: 'communication';
      toolCallId: string;
      targetNodeId?: string;
      /** Target agent display name from the communication_exec args. */
      targetAgentName?: string;
      /** The parent AI message that triggered the communication_exec tool call.
       *  Its text content is rendered as the first item inside the block. */
      parentMessage?: ThreadMessageDto;
      instructionMessage?: ThreadMessageDto;
      innerMessages: PreparedMessage[];
      resultText?: string;
      errorText?: string;
      model?: string;
      status: ToolRenderStatus;
      id: string;
      nodeId?: string;
      createdAt?: string;
      sourceAgentNodeId?: string;
    };
