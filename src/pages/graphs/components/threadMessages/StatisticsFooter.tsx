import { Typography } from 'antd';
import React from 'react';

import type { ThreadMessageDtoRequestTokenUsage } from '../../../../autogenerated';
import type { SubagentStatistics } from './threadMessagesTypes';
import {
  formatRequestTokenCount,
  formatRequestUsdShort,
} from './threadMessagesViewUtils';
import { TokenUsagePopoverIcon } from './TokenUsagePopoverIcon';

const { Text } = Typography;

const FOOTER_STYLE: React.CSSProperties = {
  display: 'flex',
  flexWrap: 'wrap',
  gap: 10,
  paddingTop: 4,
  fontSize: 11,
  color: '#8c8c8c',
};

interface StatisticsFooterProps {
  statistics?: SubagentStatistics;
  model?: string;
  /** LLM request-level token usage (input message that triggered the tool call). */
  requestTokenUsageIn?: ThreadMessageDtoRequestTokenUsage | null;
  /** LLM request-level token usage (tool result message). */
  requestTokenUsageOut?: ThreadMessageDtoRequestTokenUsage | null;
}

export const StatisticsFooter: React.FC<StatisticsFooterProps> = ({
  statistics,
  model,
  requestTokenUsageIn,
  requestTokenUsageOut,
}) => {
  if (!statistics && !model) return null;

  const items: { label: string; value: string }[] = [];

  if (statistics?.usage?.totalTokens) {
    items.push({
      label: 'Tokens',
      value: formatRequestTokenCount(statistics.usage.totalTokens),
    });
  }
  const totalPrice = statistics?.usage?.totalPrice ?? statistics?.totalPrice;
  if (typeof totalPrice === 'number' && totalPrice > 0) {
    items.push({
      label: 'Cost',
      value: formatRequestUsdShort(totalPrice),
    });
  }
  if (typeof statistics?.toolCallsMade === 'number') {
    items.push({ label: 'Tools', value: String(statistics.toolCallsMade) });
  }
  if (model) {
    items.push({ label: 'Model', value: model });
  }

  if (items.length === 0) return null;

  // Use LLM request-level token usage for the popover icon (not the internal
  // subagent/tool statistics). Fall back to the "in" usage when only one is
  // available; TokenUsagePopoverIcon handles both in+out when present.
  const hasRequestUsage = requestTokenUsageIn || requestTokenUsageOut;

  return (
    <div style={FOOTER_STYLE}>
      {items.map((item) => (
        <span key={item.label}>
          <Text type="secondary" style={{ fontSize: 11, fontWeight: 600 }}>
            {item.label}:
          </Text>{' '}
          <Text type="secondary" style={{ fontSize: 11 }}>
            {item.value}
          </Text>
        </span>
      ))}
      {hasRequestUsage && (
        <TokenUsagePopoverIcon
          requestTokenUsageIn={requestTokenUsageIn}
          requestTokenUsageOut={requestTokenUsageOut}
        />
      )}
    </div>
  );
};

StatisticsFooter.displayName = 'StatisticsFooter';
