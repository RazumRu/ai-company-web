import { LoadingOutlined } from '@ant-design/icons';
import { Tag, Typography } from 'antd';
import React, { useMemo } from 'react';

import type { ThreadMessageDto } from '../../../../autogenerated';
import { MarkdownContent } from '../../../../components/markdown/MarkdownContent';
import { formatMessageContent } from './messageUtils';
import { StyledSection } from './StyledSection';
import type { PreparedMessage } from './threadMessagesTypes';

const { Text } = Typography;

const HEADER_LABEL_STYLE: React.CSSProperties = {
  fontSize: 12,
  fontWeight: 600,
  color: '#434343',
  flex: 1,
  overflow: 'hidden',
  textOverflow: 'ellipsis',
  whiteSpace: 'nowrap',
};

const INNER_AREA_STYLE: React.CSSProperties = {
  overflowX: 'hidden',
  padding: '8px 10px',
  backgroundColor: '#fafafa',
  borderRadius: 6,
  border: '1px solid #f0f0f0',
};

const TAG_STYLE: React.CSSProperties = {
  margin: 0,
  fontSize: 11,
  lineHeight: '18px',
};

export interface CommunicationBlockProps {
  targetAgentName?: string;
  targetAvatarSrc?: string;
  /** The parent AI message whose text content triggered the communication. */
  parentMessage?: ThreadMessageDto;
  instructionMessage?: ThreadMessageDto;
  status: 'calling' | 'executed' | 'stopped';
  innerMessages: PreparedMessage[];
  resultText?: string;
  errorText?: string;
  renderItem: (item: PreparedMessage, index: number) => React.ReactNode;
}

export const CommunicationBlock: React.FC<CommunicationBlockProps> = ({
  targetAgentName,
  targetAvatarSrc,
  parentMessage,
  instructionMessage,
  status,
  innerMessages,
  resultText,
  errorText,
  renderItem,
}) => {
  const isCalling = status === 'calling';

  const headerLabel = targetAgentName
    ? `Communication: ${targetAgentName}`
    : 'Agent Communication';

  const parentContent = useMemo(() => {
    if (!parentMessage) return undefined;
    const raw = parentMessage.message?.content;
    if (!raw) return undefined;
    return formatMessageContent(raw);
  }, [parentMessage]);

  const instructionContent = useMemo(() => {
    if (!instructionMessage) return undefined;
    const raw = instructionMessage.message?.content;
    if (!raw) return undefined;
    return formatMessageContent(raw);
  }, [instructionMessage]);

  const instructionLabel = targetAgentName
    ? `Providing Instructions for ${targetAgentName}`
    : 'Providing Instructions';
  const errorLabel = targetAgentName
    ? `Error from ${targetAgentName}`
    : 'Error';
  const resultLabel = targetAgentName
    ? `Result from ${targetAgentName}`
    : 'Result';

  return (
    <div
      style={{
        display: 'flex',
        flexDirection: 'column',
        gap: 6,
        width: '100%',
      }}>
      {/* Header row */}
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: 6,
        }}>
        {isCalling && (
          <LoadingOutlined style={{ fontSize: 11, color: '#595959' }} />
        )}
        {targetAvatarSrc && (
          <img
            src={targetAvatarSrc}
            alt=""
            style={{
              width: 18,
              height: 18,
              borderRadius: '50%',
              flexShrink: 0,
            }}
          />
        )}
        <Text style={HEADER_LABEL_STYLE}>{headerLabel}</Text>
        {status === 'executed' && !errorText && (
          <Tag color="success" style={TAG_STYLE}>
            done
          </Tag>
        )}
        {status === 'executed' && errorText && (
          <Tag color="error" style={TAG_STYLE}>
            error
          </Tag>
        )}
        {status === 'stopped' && <Tag style={TAG_STYLE}>stopped</Tag>}
        {status === 'calling' && (
          <Tag color="processing" style={TAG_STYLE}>
            running
          </Tag>
        )}
      </div>

      {/* Parent AI text */}
      {parentContent && (
        <div
          style={{
            padding: '6px 10px',
            fontSize: 12,
            color: '#595959',
            backgroundColor: '#fafafa',
            borderRadius: 6,
            border: '1px solid #f0f0f0',
            lineHeight: 1.5,
          }}>
          <MarkdownContent
            content={parentContent}
            style={{
              fontSize: '12px',
              lineHeight: '1.4',
              color: '#333',
            }}
          />
        </div>
      )}

      {/* Instruction content */}
      {instructionContent && (
        <StyledSection
          variant="instruction"
          label={instructionLabel}
          content={instructionContent}
        />
      )}

      {/* Inner messages area */}
      {(innerMessages.length > 0 || isCalling) && (
        <div style={INNER_AREA_STYLE}>
          {innerMessages.length === 0 && isCalling && (
            <Text
              type="secondary"
              style={{ fontSize: 12, fontStyle: 'italic' }}>
              Agent is working...
            </Text>
          )}
          {innerMessages.map((item, idx) => (
            <div
              key={item.id || idx}
              style={
                idx < innerMessages.length - 1 ? { marginBottom: 4 } : undefined
              }>
              {renderItem(item, idx)}
            </div>
          ))}
        </div>
      )}

      {errorText && (
        <StyledSection variant="error" label={errorLabel} content={errorText} />
      )}

      {resultText && !errorText && (
        <StyledSection
          variant="result"
          label={resultLabel}
          content={resultText}
        />
      )}
    </div>
  );
};

CommunicationBlock.displayName = 'CommunicationBlock';
