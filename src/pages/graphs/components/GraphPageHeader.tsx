import {
  CheckOutlined,
  CloseOutlined,
  DownOutlined,
  EditOutlined,
  EllipsisOutlined,
  ExclamationCircleOutlined,
  LoadingOutlined,
  PlayCircleFilled,
  SaveFilled,
  XFilled,
} from '@ant-design/icons';
import {
  Button,
  Dropdown,
  Input,
  Layout,
  Popover,
  Tag,
  Tooltip,
  Typography,
} from 'antd';
import type { FC, ReactNode } from 'react';

import { GraphDto, ThreadDto } from '../../../autogenerated';
import { ThreadSelectorPopover } from './ThreadSelectorPopover';

const { Header } = Layout;
const { Title } = Typography;

interface GraphPageHeaderProps {
  // Name editing
  graphName: string;
  isEditingName: boolean;
  editingName: string;
  isSavingName: boolean;
  onEditingNameChange: (name: string) => void;
  onNameEdit: () => void;
  onNameSave: () => void;
  onNameCancel: () => void;

  // Revision
  graph: GraphDto | null;
  revisionPopoverVisible: boolean;
  onRevisionPopoverChange: (open: boolean) => void;
  onLoadRevisions: () => void;
  revisionPopoverContent: ReactNode;
  displayedVersion: string | number;
  displayedRevisionMeta: {
    label: string;
    color: string;
    pulse?: boolean;
  } | null;

  // Thread selector
  threads: ThreadDto[];
  threadsLoading: boolean;
  selectedThreadId: string | undefined;
  threadPopoverVisible: boolean;
  onThreadPopoverChange: (open: boolean) => void;
  onThreadSelect: (threadId: string | undefined) => void;
  onDeleteThread: (threadId: string) => Promise<void>;
  onStopThread: (threadId: string) => Promise<void>;
  onOpenThreadChat: (threadId: string) => void;
  deletingThreadId: string | null;
  stoppingThreadId: string | null;

  // Error display
  graphError: string | null;

  // Save/Run actions
  saving: boolean;
  isRevisionApplying: boolean;
  hasStructuralChanges: boolean;
  unsavedChangesPopoverContent: ReactNode;
  onSave: () => void;
  isGraphRunning: boolean;
  isGraphCompiling: boolean;
  actionLoading: boolean;
  onGraphAction: () => void;

  // Menu
  graphMenuItems: {
    key: string;
    disabled?: boolean;
    label: ReactNode;
  }[];
  onGraphMenuAction: (key: string) => void;
}

export const GraphPageHeader: FC<GraphPageHeaderProps> = ({
  graphName,
  isEditingName,
  editingName,
  isSavingName,
  onEditingNameChange,
  onNameEdit,
  onNameSave,
  onNameCancel,

  graph,
  revisionPopoverVisible,
  onRevisionPopoverChange,
  onLoadRevisions,
  revisionPopoverContent,
  displayedVersion,
  displayedRevisionMeta,

  threads,
  threadsLoading,
  selectedThreadId,
  threadPopoverVisible,
  onThreadPopoverChange,
  onThreadSelect,
  onDeleteThread,
  onStopThread,
  onOpenThreadChat,
  deletingThreadId,
  stoppingThreadId,

  graphError,

  saving,
  isRevisionApplying,
  hasStructuralChanges,
  unsavedChangesPopoverContent,
  onSave,
  isGraphRunning,
  isGraphCompiling,
  actionLoading,
  onGraphAction,

  graphMenuItems,
  onGraphMenuAction,
}) => {
  return (
    <Header
      style={{
        background: '#fff',
        padding: '0 24px',
        borderBottom: '1px solid #f0f0f0',
        flexShrink: 0,
        height: 70,
      }}>
      <div
        style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          gap: 24,
          height: '100%',
        }}>
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            flexWrap: 'wrap',
          }}>
          {isEditingName ? (
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <Input
                value={editingName}
                onChange={(e) => onEditingNameChange(e.target.value)}
                onPressEnter={onNameSave}
                onBlur={onNameSave}
                disabled={isSavingName}
                autoFocus
                style={{ width: 300 }}
              />
              <Button
                type="text"
                icon={<CheckOutlined />}
                onClick={onNameSave}
                size="small"
                disabled={isSavingName}
              />
              <Button
                type="text"
                icon={<CloseOutlined />}
                onClick={onNameCancel}
                size="small"
                disabled={isSavingName}
              />
            </div>
          ) : (
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <Title level={4} style={{ margin: 0 }}>
                {graphName}
              </Title>
              <Button
                type="text"
                icon={<EditOutlined />}
                onClick={onNameEdit}
                size="small"
              />
            </div>
          )}
          {graph && (
            <div style={{ marginLeft: 16 }}>
              <Popover
                open={revisionPopoverVisible}
                onOpenChange={(open) => {
                  onRevisionPopoverChange(open);
                  if (open) {
                    onLoadRevisions();
                  }
                }}
                trigger="click"
                placement="bottomLeft"
                content={revisionPopoverContent}>
                <Button
                  type="text"
                  size="small"
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 6,
                    padding: '4px 8px',
                    height: 'auto',
                    borderRadius: 6,
                    backgroundColor: revisionPopoverVisible
                      ? '#f5f5f5'
                      : 'transparent',
                  }}>
                  <Typography.Text style={{ fontSize: 12, color: '#595959' }}>
                    Version {displayedVersion}
                  </Typography.Text>
                  {displayedRevisionMeta && (
                    <Tag
                      color={displayedRevisionMeta.color}
                      style={{
                        margin: 0,
                        borderRadius: 999,
                        fontSize: 11,
                        lineHeight: '18px',
                        padding: '0 8px',
                        boxShadow: displayedRevisionMeta.pulse
                          ? '0 0 0 0 rgba(250, 173, 20, 0.45)'
                          : 'none',
                        animation: displayedRevisionMeta.pulse
                          ? 'revision-status-pulse 1.5s ease-out infinite'
                          : undefined,
                      }}>
                      {displayedRevisionMeta.label}
                    </Tag>
                  )}
                  <DownOutlined style={{ fontSize: 10, color: '#8c8c8c' }} />
                </Button>
              </Popover>
            </div>
          )}
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <ThreadSelectorPopover
            threads={threads}
            threadsLoading={threadsLoading}
            selectedThreadId={selectedThreadId}
            threadPopoverVisible={threadPopoverVisible}
            onOpenChange={onThreadPopoverChange}
            onThreadSelect={onThreadSelect}
            onDeleteThread={onDeleteThread}
            onStopThread={onStopThread}
            onOpenThreadChat={onOpenThreadChat}
            deletingThreadId={deletingThreadId}
            stoppingThreadId={stoppingThreadId}
          />

          {(graph?.error || graphError) && (
            <Popover
              content={
                <div style={{ maxWidth: 500 }}>
                  <div style={{ fontWeight: 'bold', marginBottom: 8 }}>
                    Graph Error:
                  </div>
                  <div>{graph?.error || graphError}</div>
                </div>
              }
              title="Error Details"
              trigger="hover"
              color="#ffd7d9"
              placement="bottomRight">
              <ExclamationCircleOutlined
                style={{
                  color: '#ff4d4f',
                  fontSize: 16,
                  cursor: 'pointer',
                }}
              />
            </Popover>
          )}
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: 0,
            }}>
            <Tooltip
              title={
                isRevisionApplying
                  ? 'Applying revision...'
                  : hasStructuralChanges
                    ? 'Save (unsaved changes)'
                    : 'Save'
              }
              placement="bottom">
              <Popover
                content={unsavedChangesPopoverContent}
                title="Unsaved Changes"
                open={hasStructuralChanges ? undefined : false}
                trigger="hover">
                <span
                  role="button"
                  aria-label="Save graph"
                  aria-disabled={saving || isRevisionApplying}
                  style={{
                    width: 36,
                    height: 36,
                    borderRadius: 8,
                    color: hasStructuralChanges ? '#ffd421' : '#3085e0',
                    display: 'inline-flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor:
                      saving || isRevisionApplying ? 'progress' : 'pointer',
                    transition: 'background-color 0.2s',
                  }}
                  onClick={() => {
                    if (!saving && !isRevisionApplying) {
                      onSave();
                    }
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#f0f0f0';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = 'transparent';
                  }}>
                  {saving || isRevisionApplying ? (
                    <LoadingOutlined style={{ fontSize: 20 }} spin />
                  ) : (
                    <SaveFilled style={{ fontSize: 20 }} />
                  )}
                </span>
              </Popover>
            </Tooltip>
            {graph && (
              <Tooltip
                title={
                  isGraphRunning
                    ? 'Stop graph'
                    : isGraphCompiling
                      ? 'Compiling...'
                      : 'Run graph'
                }
                placement="bottom">
                <span
                  role="button"
                  aria-label={
                    isGraphRunning ? 'Stop graph' : 'Start graph execution'
                  }
                  style={{
                    width: 36,
                    height: 36,
                    borderRadius: 8,
                    color: isGraphRunning ? '#ff4242' : '#52c41a',
                    display: 'inline-flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor:
                      actionLoading || isGraphCompiling
                        ? 'progress'
                        : 'pointer',
                    transition: 'background-color 0.2s',
                  }}
                  onClick={() => {
                    if (!actionLoading && !isGraphCompiling) {
                      onGraphAction();
                    }
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#f0f0f0';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = 'transparent';
                  }}>
                  {actionLoading || isGraphCompiling ? (
                    <LoadingOutlined style={{ fontSize: 20 }} spin />
                  ) : isGraphRunning ? (
                    <XFilled style={{ fontSize: 20 }} />
                  ) : (
                    <PlayCircleFilled style={{ fontSize: 20 }} />
                  )}
                </span>
              </Tooltip>
            )}
            <Dropdown
              trigger={['click']}
              placement="bottomRight"
              menu={{
                items: graphMenuItems,
                onClick: ({ key }) => onGraphMenuAction(key),
              }}>
              <Button
                type="text"
                size="small"
                icon={<EllipsisOutlined />}
                aria-label="Graph actions"
                style={{
                  width: 36,
                  height: 36,
                  borderRadius: 8,
                  color: '#6b7280',
                }}
              />
            </Dropdown>
          </div>
        </div>
      </div>
    </Header>
  );
};
