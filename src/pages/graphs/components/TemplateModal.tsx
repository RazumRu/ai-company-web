import { Card, List, Modal, Space, Tag, Typography } from 'antd';
import { InfoCircleOutlined, LinkOutlined } from '@ant-design/icons';
import type { TemplateDto } from '../../../autogenerated';
import JsonView from '@uiw/react-json-view';
import { lightTheme } from '@uiw/react-json-view/light';

const { Title, Text, Paragraph } = Typography;

interface TemplateModalProps {
  template: TemplateDto | null;
  visible: boolean;
  onClose: () => void;
  allTemplates?: TemplateDto[];
}

export const TemplateModal = ({
  template,
  visible,
  onClose,
  allTemplates = [],
}: TemplateModalProps) => {
  if (!template) return null;

  return (
    <Modal
      title={
        <Space>
          <InfoCircleOutlined />
          Template Details
        </Space>
      }
      open={visible}
      onCancel={onClose}
      footer={null}
      width={900}
      styles={{ body: { maxHeight: '80vh', overflowY: 'auto' } }}>
      <Space direction="vertical" size="large" style={{ width: '100%' }}>
        <div>
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: 12,
              marginBottom: 8,
            }}>
            <Title level={3} style={{ margin: 0 }}>
              {template.name}
            </Title>
            <span
              style={{
                background: '#1890ff',
                color: 'white',
                padding: '2px 8px',
                borderRadius: 4,
                fontSize: 12,
                fontWeight: 500,
              }}>
              {template.kind}
            </span>
          </div>
          <Paragraph style={{ margin: 0, fontSize: 14 }}>
            {template.description}
          </Paragraph>
        </div>

        {template.inputs && template.inputs.length > 0 ? (
          <div>
            <Title level={4} style={{ marginBottom: 16 }}>
              <LinkOutlined style={{ marginRight: 8 }} />
              Available Inputs
            </Title>
            <Text
              type="secondary"
              style={{ marginBottom: 16, display: 'block' }}>
              This template can accept the following input types:
            </Text>
            <List
              size="small"
              dataSource={template.inputs}
              renderItem={(rule) => {
                const matchingTemplates = allTemplates.filter((t) => {
                  if (rule.type === 'kind') {
                    return t.kind === rule.value;
                  } else if (rule.type === 'template') {
                    return t.name === rule.value;
                  }
                  return false;
                });

                return (
                  <List.Item>
                    <Space direction="vertical" style={{ width: '100%' }}>
                      <div>
                        <Tag color="blue">{rule.type}</Tag>
                        <Text strong>{rule.value}</Text>
                        {rule.required && <Tag color="red" style={{ marginLeft: 8 }}>Required</Tag>}
                        {rule.multiple && <Tag color="orange" style={{ marginLeft: 8 }}>Multiple</Tag>}
                      </div>
                      {matchingTemplates.length > 0 && (
                        <div
                          style={{
                            marginLeft: 16,
                            display: 'flex',
                            gap: 10,
                            flexWrap: 'wrap',
                          }}>
                          {matchingTemplates.map((t) => (
                            <Card
                              key={t.name}
                              size="small"
                              style={{
                                marginBottom: 8,
                                width: 300,
                                flexBasis: '300px',
                              }}>
                              <Space direction="vertical" size="small">
                                <Text strong>{t.name}</Text>
                                <Tag color="green">{t.kind}</Tag>
                                <Text type="secondary" style={{ fontSize: 12 }}>
                                  {t.description}
                                </Text>
                              </Space>
                            </Card>
                          ))}
                        </div>
                      )}
                    </Space>
                  </List.Item>
                );
              }}
            />
          </div>
        ) : (
          <div
            style={{
              marginTop: 0,
              padding: 12,
              background: '#f5f5f5',
              borderRadius: 4,
              border: '1px solid #d9d9d9',
              display: 'inline-block',
            }}>
            <Text type="secondary" style={{ fontSize: 12, color: '#8c8c8c' }}>
              No available inputs for this node
            </Text>
          </div>
        )}

        <div>
          <Title level={4} style={{ marginBottom: 16 }}>
            Schema Definition
          </Title>
          <div style={{}}>
            <div className="json-schema-viewer">
              <JsonView value={template.schema} style={lightTheme} />
            </div>
          </div>
        </div>
      </Space>
    </Modal>
  );
};
