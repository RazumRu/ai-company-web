import {
  DeleteOutlined,
  LoadingOutlined,
  MessageOutlined,
  XFilled,
} from '@ant-design/icons';
import { Button, Popconfirm, Popover, Tag, Tooltip, Typography } from 'antd';
import { type FC, useMemo } from 'react';

import { ThreadDto, ThreadDtoStatusEnum } from '../../../autogenerated';
import { getThreadStatusDisplay } from '../../../utils/threadStatus';

interface ThreadSelectorPopoverProps {
  threads: ThreadDto[];
  threadsLoading: boolean;
  selectedThreadId: string | undefined;
  threadPopoverVisible: boolean;
  onOpenChange: (open: boolean) => void;
  onThreadSelect: (threadId: string | undefined) => void;
  onDeleteThread: (threadId: string) => Promise<void>;
  onStopThread: (threadId: string) => Promise<void>;
  onOpenThreadChat: (threadId: string) => void;
  deletingThreadId: string | null;
  stoppingThreadId: string | null;
}

export const ThreadSelectorPopover: FC<ThreadSelectorPopoverProps> = ({
  threads,
  threadsLoading,
  selectedThreadId,
  threadPopoverVisible,
  onOpenChange,
  onThreadSelect,
  onDeleteThread,
  onStopThread,
  onOpenThreadChat,
  deletingThreadId,
  stoppingThreadId,
}) => {
  const selectedThread = useMemo(
    () => threads.find((t) => t.id === selectedThreadId),
    [threads, selectedThreadId],
  );
  const selectedThreadStatusMeta = useMemo(
    () => getThreadStatusDisplay(selectedThread?.status),
    [selectedThread?.status],
  );

  return (
    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
      <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
        <div
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: 8,
          }}>
          <Popover
            open={threadPopoverVisible}
            placement="bottomLeft"
            content={
              <div
                style={{
                  maxHeight: 300,
                  overflowY: 'auto',
                  minWidth: 320,
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: 4,
                }}>
                <Button
                  key="__new_thread__"
                  type="text"
                  style={{
                    textAlign: 'left',
                    padding: '8px 12px',
                    height: 'auto',
                    lineHeight: 1.2,
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'flex-start',
                    border: '1px solid #f0f0f0',
                    borderRadius: 6,
                    width: '100%',
                  }}
                  onClick={() => onThreadSelect(undefined)}>
                  <Typography.Text
                    strong
                    style={{ fontSize: '12px', lineHeight: 1.2 }}>
                    + New thread
                  </Typography.Text>
                  <Typography.Text
                    type="secondary"
                    style={{ fontSize: '12px', lineHeight: 1.2 }}>
                    Clear current selection
                  </Typography.Text>
                </Button>

                {threadsLoading ? (
                  <Typography.Text
                    type="secondary"
                    style={{ fontSize: '12px' }}>
                    Loading threads...
                  </Typography.Text>
                ) : threads.length === 0 ? (
                  <Typography.Text
                    type="secondary"
                    style={{ fontSize: '12px' }}>
                    No threads available
                  </Typography.Text>
                ) : (
                  threads.map((thread) => {
                    const statusMeta = getThreadStatusDisplay(thread.status);
                    const isThreadRunning =
                      thread.status === ThreadDtoStatusEnum.Running;
                    return (
                      <div
                        key={thread.id}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 8,
                          width: '100%',
                          border: '1px solid #f0f0f0',
                          borderRadius: 6,
                          padding: '4px 4px',
                        }}>
                        <Button
                          type="text"
                          style={{
                            textAlign: 'left',
                            padding: '8px 12px',
                            height: 'auto',
                            lineHeight: 1.2,
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'flex-start',
                            border: 'none',
                            boxShadow: 'none',
                            flex: 1,
                            gap: 0,
                          }}
                          onClick={() => onThreadSelect(thread.id)}>
                          <div
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: 8,
                              width: '100%',
                              justifyContent: 'space-between',
                            }}>
                            <div
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: 8,
                                minWidth: 0,
                              }}>
                              <Typography.Text
                                strong
                                style={{
                                  fontSize: '12px',
                                  lineHeight: 1.2,
                                  maxWidth: '400px',
                                  whiteSpace: 'nowrap',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                }}>
                                {thread.name || thread.id}
                              </Typography.Text>
                              <Popconfirm
                                title="Delete thread"
                                description="Are you sure you want to delete this thread?"
                                okText="Delete"
                                okButtonProps={{
                                  danger: true,
                                  loading: deletingThreadId === thread.id,
                                }}
                                cancelText="Cancel"
                                disabled={deletingThreadId === thread.id}
                                onConfirm={(e) => {
                                  e?.stopPropagation?.();
                                  onDeleteThread(thread.id);
                                }}>
                                <span
                                  role="button"
                                  aria-label={`Delete thread ${thread.name || thread.id}`}
                                  tabIndex={0}
                                  style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    width: 24,
                                    height: 24,
                                    borderRadius: '50%',
                                    color: '#ff4d4f',
                                    backgroundColor: 'transparent',
                                    transition: 'background-color 0.2s',
                                    cursor: 'pointer',
                                  }}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                  }}
                                  onKeyDown={(e) => {
                                    if (e.key === 'Enter' || e.key === ' ') {
                                      e.preventDefault();
                                      e.stopPropagation();
                                      (e.currentTarget as HTMLElement).click();
                                    }
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.backgroundColor =
                                      'rgba(255, 77, 79, 0.08)';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.backgroundColor =
                                      'transparent';
                                  }}>
                                  {deletingThreadId === thread.id ? (
                                    <LoadingOutlined
                                      style={{ fontSize: 12 }}
                                      spin
                                    />
                                  ) : (
                                    <DeleteOutlined />
                                  )}
                                </span>
                              </Popconfirm>
                            </div>
                            {statusMeta && (
                              <Tag
                                color={statusMeta.color}
                                style={{
                                  margin: 0,
                                  borderRadius: 999,
                                  fontSize: '11px',
                                  lineHeight: '18px',
                                  padding: '0 8px',
                                  boxShadow: isThreadRunning
                                    ? '0 0 0 0 rgba(24, 144, 255, 0.45)'
                                    : 'none',
                                  animation: isThreadRunning
                                    ? 'thread-status-pulse 1.5s ease-out infinite'
                                    : undefined,
                                }}>
                                {statusMeta.label}
                              </Tag>
                            )}
                          </div>
                          <Typography.Text
                            type="secondary"
                            style={{ fontSize: '12px', lineHeight: 1.2 }}>
                            {new Date(thread.createdAt).toLocaleString()}
                          </Typography.Text>
                          {thread.source ? (
                            <Typography.Text
                              type="secondary"
                              style={{
                                fontSize: '12px',
                                lineHeight: 1.2,
                                marginTop: '10px',
                              }}>
                              Source: {thread.source}
                            </Typography.Text>
                          ) : null}
                        </Button>
                      </div>
                    );
                  })
                )}
              </div>
            }
            trigger="click"
            onOpenChange={onOpenChange}>
            <div
              style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'flex-start',
                cursor: 'pointer',
                padding: '4px 8px',
                borderRadius: '4px',
                transition: 'background-color 0.2s',
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.backgroundColor = '#f5f5f5';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.backgroundColor = 'transparent';
              }}>
              {(() => {
                const source = selectedThread?.source;
                const label = (
                  <Typography.Text
                    strong
                    style={{ fontSize: '14px', lineHeight: 1 }}>
                    Thread
                  </Typography.Text>
                );
                return source ? (
                  <Tooltip title={`Source: ${source}`}>{label}</Tooltip>
                ) : (
                  label
                );
              })()}
              {selectedThreadId ? (
                <>
                  <div
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: 6,
                      flexWrap: 'wrap',
                    }}>
                    <div
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 6,
                      }}>
                      <Typography.Text
                        style={{
                          fontSize: '12px',
                          lineHeight: 1.2,
                          maxWidth: '400px',
                          whiteSpace: 'nowrap',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                        }}>
                        {selectedThread?.name || selectedThreadId}
                      </Typography.Text>
                      {selectedThreadId && (
                        <>
                          {selectedThread?.status ===
                            ThreadDtoStatusEnum.Running && (
                            <Tooltip title="Stop thread execution">
                              <span
                                role="button"
                                aria-label="Stop current thread"
                                tabIndex={0}
                                style={{
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  width: 24,
                                  height: 24,
                                  borderRadius: '50%',
                                  color: '#ff4242',
                                  backgroundColor: 'transparent',
                                  transition: 'background-color 0.2s',
                                  cursor:
                                    stoppingThreadId === selectedThreadId
                                      ? 'default'
                                      : 'pointer',
                                  marginLeft: 4,
                                  opacity:
                                    stoppingThreadId === selectedThreadId
                                      ? 0.7
                                      : 1,
                                }}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (stoppingThreadId === selectedThreadId) {
                                    return;
                                  }
                                  onStopThread(selectedThreadId);
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter' || e.key === ' ') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (stoppingThreadId === selectedThreadId) {
                                      return;
                                    }
                                    onStopThread(selectedThreadId);
                                  }
                                }}
                                onMouseEnter={(e) => {
                                  if (stoppingThreadId === selectedThreadId) {
                                    return;
                                  }
                                  e.currentTarget.style.backgroundColor =
                                    'rgba(255, 66, 66, 0.08)';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.backgroundColor =
                                    'transparent';
                                }}>
                                {stoppingThreadId === selectedThreadId ? (
                                  <LoadingOutlined
                                    style={{ fontSize: 12 }}
                                    spin
                                  />
                                ) : (
                                  <XFilled />
                                )}
                              </span>
                            </Tooltip>
                          )}
                          <Tooltip title="Open chat for thread">
                            <span
                              role="button"
                              aria-label="Open chat for current thread"
                              tabIndex={0}
                              style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                width: 24,
                                height: 24,
                                borderRadius: '50%',
                                color: '#1677ff',
                                backgroundColor: 'transparent',
                                transition: 'background-color 0.2s',
                                cursor: 'pointer',
                                marginLeft: 4,
                              }}
                              onClick={(e) => {
                                e.stopPropagation();
                                onOpenThreadChat(selectedThreadId);
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' || e.key === ' ') {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  onOpenThreadChat(selectedThreadId);
                                }
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.backgroundColor =
                                  'rgba(22, 119, 255, 0.08)';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.backgroundColor =
                                  'transparent';
                              }}>
                              <MessageOutlined />
                            </span>
                          </Tooltip>
                          <Popconfirm
                            title="Delete thread"
                            description="Are you sure you want to delete the selected thread?"
                            okText="Delete"
                            okButtonProps={{
                              danger: true,
                              loading: deletingThreadId === selectedThreadId,
                            }}
                            cancelText="Cancel"
                            disabled={deletingThreadId === selectedThreadId}
                            onConfirm={(e) => {
                              e?.stopPropagation?.();
                              onDeleteThread(selectedThreadId);
                            }}>
                            <span
                              role="button"
                              aria-label="Delete current thread"
                              tabIndex={0}
                              style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                width: 24,
                                height: 24,
                                borderRadius: '50%',
                                color: '#ff4d4f',
                                backgroundColor: 'transparent',
                                transition: 'background-color 0.2s',
                                cursor: 'pointer',
                              }}
                              onClick={(e) => {
                                e.stopPropagation();
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' || e.key === ' ') {
                                  e.preventDefault();
                                  e.stopPropagation();
                                  (e.currentTarget as HTMLElement).click();
                                }
                              }}
                              onMouseEnter={(e) => {
                                e.currentTarget.style.backgroundColor =
                                  'rgba(255, 77, 79, 0.08)';
                              }}
                              onMouseLeave={(e) => {
                                e.currentTarget.style.backgroundColor =
                                  'transparent';
                              }}>
                              {deletingThreadId === selectedThreadId ? (
                                <LoadingOutlined
                                  style={{ fontSize: 12 }}
                                  spin
                                />
                              ) : (
                                <DeleteOutlined />
                              )}
                            </span>
                          </Popconfirm>
                        </>
                      )}
                    </div>
                    {selectedThreadStatusMeta && (
                      <Tag
                        color={selectedThreadStatusMeta.color}
                        style={{
                          margin: 0,
                          borderRadius: 999,
                          fontSize: '11px',
                          lineHeight: '18px',
                          padding: '0 8px',
                          boxShadow:
                            selectedThread?.status ===
                            ThreadDtoStatusEnum.Running
                              ? '0 0 0 0 rgba(24, 144, 255, 0.45)'
                              : 'none',
                          animation:
                            selectedThread?.status ===
                            ThreadDtoStatusEnum.Running
                              ? 'thread-status-pulse 1.5s ease-out infinite'
                              : undefined,
                        }}>
                        {selectedThreadStatusMeta.label}
                      </Tag>
                    )}
                  </div>
                  <Typography.Text
                    type="secondary"
                    style={{ fontSize: '12px', lineHeight: 1.2 }}>
                    {selectedThread
                      ? `${new Date(selectedThread.createdAt).toLocaleString()} | ${selectedThread.source || 'unknown source'}`
                      : ''}
                  </Typography.Text>
                </>
              ) : (
                <>
                  <Typography.Text
                    type="secondary"
                    style={{ fontSize: '12px', lineHeight: 1.2 }}>
                    No active thread.
                  </Typography.Text>
                  <Typography.Text
                    type="secondary"
                    style={{ fontSize: '12px', lineHeight: 1.2 }}>
                    It will be created automatically after first execution.
                  </Typography.Text>
                </>
              )}
            </div>
          </Popover>
        </div>
      </div>
    </div>
  );
};
