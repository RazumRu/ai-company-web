import { Modal, Space, Tag, Typography } from 'antd';
import type { ReactNode } from 'react';

import type { GraphRevisionDto } from '../../../autogenerated';
import { REVISION_DIFF_OP_META } from '../utils/graphPageUtils';

interface RevisionDiffModalProps {
  revision: GraphRevisionDto | null;
  visible: boolean;
  onClose: () => void;
  formatDiffValue: (value: unknown) => ReactNode | null;
}

export const RevisionDiffModal = ({
  revision,
  visible,
  onClose,
  formatDiffValue,
}: RevisionDiffModalProps) => (
  <Modal
    open={visible}
    onCancel={onClose}
    footer={null}
    title={revision ? `Revision v${revision.toVersion} diff` : 'Revision diff'}
    width={640}
    destroyOnClose>
    {revision ? (
      <Space direction="vertical" size="large" style={{ width: '100%' }}>
        {revision.configDiff.length === 0 ? (
          <Typography.Text type="secondary">
            No configuration changes.
          </Typography.Text>
        ) : (
          revision.configDiff.map((operation, index) => {
            const meta = REVISION_DIFF_OP_META[operation.op] ?? {
              label: operation.op,
              color: '#d9d9d9',
            };
            const key = `${operation.op}-${operation.path}-${index}`;
            const value = (operation as { value?: unknown }).value ?? undefined;
            const fromPath = (operation as { from?: string }).from ?? undefined;
            return (
              <div
                key={key}
                style={{
                  border: '1px solid #f0f0f0',
                  borderLeft: `4px solid ${meta.color}`,
                  borderRadius: 6,
                  padding: '12px 14px',
                  background: '#fafafa',
                }}>
                <Space direction="vertical" size={6} style={{ width: '100%' }}>
                  <Space
                    align="center"
                    wrap
                    style={{ justifyContent: 'space-between' }}>
                    <Tag
                      color={meta.color}
                      style={{
                        margin: 0,
                        fontSize: 11,
                        padding: '0 10px',
                      }}>
                      {meta.label}
                    </Tag>
                    <Typography.Text code style={{ fontSize: 12 }}>
                      {operation.path || '(root)'}
                    </Typography.Text>
                  </Space>
                  {fromPath ? (
                    <Typography.Text style={{ fontSize: 12 }}>
                      From <Typography.Text code>{fromPath}</Typography.Text>
                    </Typography.Text>
                  ) : null}
                  {value !== undefined ? formatDiffValue(value) : null}
                </Space>
              </div>
            );
          })
        )}
        {revision.error && (
          <Typography.Text type="danger">
            Error: {revision.error}
          </Typography.Text>
        )}
      </Space>
    ) : null}
  </Modal>
);
