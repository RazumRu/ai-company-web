import { App, Button, Form, Input, Modal } from 'antd';
import { useState } from 'react';

import { gitRepositoriesApi } from '../../../api';
import type { CreateRepositoryDto } from '../../../autogenerated';
import { extractApiErrorMessage } from '../../../utils/errors';

interface CreateRepositoryModalProps {
  open: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

export const CreateRepositoryModal = ({
  open,
  onClose,
  onSuccess,
}: CreateRepositoryModalProps) => {
  const { message } = App.useApp();
  const [form] = Form.useForm();
  const [creating, setCreating] = useState(false);

  const handleCreateRepository = async (values: CreateRepositoryDto) => {
    setCreating(true);
    try {
      await gitRepositoriesApi.createRepository(values);
      message.success('Repository added successfully');
      form.resetFields();
      onClose();
      onSuccess();
    } catch (e: unknown) {
      console.error('Error creating repository:', e);
      const errorMessage = extractApiErrorMessage(
        e,
        'Failed to add repository',
      );
      message.error(errorMessage);
    } finally {
      setCreating(false);
    }
  };

  const handleCancel = () => {
    form.resetFields();
    onClose();
  };

  return (
    <Modal
      title="Add Repository"
      open={open}
      onCancel={handleCancel}
      footer={null}
      centered>
      <Form
        form={form}
        layout="vertical"
        onFinish={handleCreateRepository}
        style={{ marginTop: 24 }}>
        <Form.Item
          name="owner"
          label="Owner"
          rules={[
            { required: true, message: 'Please enter the repository owner' },
          ]}>
          <Input placeholder="e.g., facebook" />
        </Form.Item>

        <Form.Item
          name="repo"
          label="Repository Name"
          rules={[
            {
              required: true,
              message: 'Please enter the repository name',
            },
          ]}>
          <Input placeholder="e.g., react" />
        </Form.Item>

        <Form.Item
          name="url"
          label="Repository URL"
          rules={[
            { required: true, message: 'Please enter the repository URL' },
            { type: 'url', message: 'Please enter a valid URL' },
          ]}>
          <Input placeholder="https://github.com/facebook/react" />
        </Form.Item>

        <Form.Item name="token" label="Personal Access Token (Optional)">
          <Input.Password placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
        </Form.Item>

        <Form.Item style={{ marginBottom: 0 }}>
          <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
            <Button onClick={handleCancel}>Cancel</Button>
            <Button type="primary" htmlType="submit" loading={creating}>
              Add Repository
            </Button>
          </div>
        </Form.Item>
      </Form>
    </Modal>
  );
};
