import {
  BarChartOutlined,
  BulbOutlined,
  DashboardOutlined,
  DatabaseOutlined,
  DollarOutlined,
  LoginOutlined,
  LogoutOutlined,
  MessageOutlined,
  NodeIndexOutlined,
  ThunderboltOutlined,
} from '@ant-design/icons';
import {
  Alert,
  Card,
  Col,
  Divider,
  Empty,
  Row,
  Space,
  Spin,
  Statistic,
  Tag,
  Typography,
} from 'antd';
import { useEffect, useState } from 'react';

import { analyticsApi } from '../../api';
import type {
  AnalyticsByGraphResponseDto,
  AnalyticsByGraphResponseDtoGraphsInner,
  AnalyticsOverviewDto,
} from '../../autogenerated';
import { extractApiErrorMessage } from '../../utils/errors';

const { Title, Paragraph, Text } = Typography;

const TOKEN_COLORS = {
  input: '#13c2c2',
  output: '#fa8c16',
  cached: '#eb2f96',
  reasoning: '#faad14',
} as const;

const formatNumber = (num?: number | null): string => {
  if (typeof num !== 'number' || !Number.isFinite(num)) return '\u2014';
  return new Intl.NumberFormat('en-US').format(num);
};

const formatUsd = (amount?: number | null): string => {
  if (typeof amount !== 'number' || !Number.isFinite(amount)) return '$\u2014';
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 4,
    maximumFractionDigits: 4,
  }).format(amount);
};

const TokenBadge = ({
  label,
  value,
  color,
}: {
  label: string;
  value: number;
  color: string;
}) => (
  <div style={{ textAlign: 'center', minWidth: 80 }}>
    <Text type="secondary" style={{ fontSize: 12, display: 'block' }}>
      {label}
    </Text>
    <Text strong style={{ fontSize: 15, color }}>
      {formatNumber(value)}
    </Text>
  </div>
);

const GraphCard = ({
  graph,
}: {
  graph: AnalyticsByGraphResponseDtoGraphsInner;
}) => (
  <Card
    hoverable
    style={{ height: '100%' }}
    styles={{ body: { padding: '20px 24px' } }}>
    {/* Header: graph name + cost */}
    <div
      style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 16,
      }}>
      <Space size={8} align="center">
        <NodeIndexOutlined style={{ fontSize: 18, color: '#1677ff' }} />
        <Text strong style={{ fontSize: 16 }}>
          {graph.graphName}
        </Text>
      </Space>
      <Tag
        color="green"
        style={{ fontSize: 13, padding: '2px 10px', margin: 0 }}>
        {formatUsd(graph.totalPrice)}
      </Tag>
    </div>

    {/* Stats row: threads + total tokens */}
    <div
      style={{
        display: 'flex',
        gap: 24,
        marginBottom: 12,
      }}>
      <Statistic
        title="Threads"
        value={graph.totalThreads}
        prefix={<MessageOutlined style={{ color: '#1677ff', fontSize: 14 }} />}
        valueStyle={{ fontSize: 18, color: '#1677ff' }}
      />
      <Statistic
        title="Total Tokens"
        value={graph.totalTokens}
        prefix={
          <ThunderboltOutlined style={{ color: '#722ed1', fontSize: 14 }} />
        }
        valueStyle={{ fontSize: 18, color: '#722ed1' }}
      />
    </div>

    <Divider style={{ margin: '12px 0' }} />

    {/* Token breakdown */}
    <div
      style={{
        display: 'flex',
        justifyContent: 'space-around',
        flexWrap: 'wrap',
        gap: 8,
      }}>
      <TokenBadge
        label="Input"
        value={graph.inputTokens}
        color={TOKEN_COLORS.input}
      />
      <TokenBadge
        label="Output"
        value={graph.outputTokens}
        color={TOKEN_COLORS.output}
      />
      {graph.cachedInputTokens > 0 && (
        <TokenBadge
          label="Cached"
          value={graph.cachedInputTokens}
          color={TOKEN_COLORS.cached}
        />
      )}
      {graph.reasoningTokens > 0 && (
        <TokenBadge
          label="Reasoning"
          value={graph.reasoningTokens}
          color={TOKEN_COLORS.reasoning}
        />
      )}
    </div>
  </Card>
);

const isEmptyOverview = (overview: AnalyticsOverviewDto): boolean =>
  overview.totalThreads === 0 &&
  overview.totalTokens === 0 &&
  overview.totalPrice === 0;

export const MainPage = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [overview, setOverview] = useState<AnalyticsOverviewDto | null>(null);
  const [byGraph, setByGraph] = useState<AnalyticsByGraphResponseDto | null>(
    null,
  );

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const [overviewRes, byGraphRes] = await Promise.all([
          analyticsApi.getOverview(),
          analyticsApi.getByGraph(),
        ]);
        if (!mounted) return;
        setOverview(overviewRes.data);
        setByGraph(byGraphRes.data);
      } catch (e) {
        if (!mounted) return;
        console.error('Error fetching analytics:', e);
        const errorMessage = extractApiErrorMessage(
          e,
          'Failed to load analytics',
        );
        setError(errorMessage);
      } finally {
        if (mounted) setLoading(false);
      }
    })();
    return () => {
      mounted = false;
    };
  }, []);

  if (loading) {
    return (
      <div
        style={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          minHeight: '60vh',
        }}>
        <Spin size="large" />
      </div>
    );
  }

  const hasGraphData = byGraph && byGraph.graphs.length > 0;
  const showEmptyState =
    !error && overview && isEmptyOverview(overview) && !hasGraphData;

  return (
    <div style={{ padding: 24, maxWidth: 1200, margin: '0 auto' }}>
      <Title level={2} style={{ marginBottom: 4 }}>
        <DashboardOutlined style={{ marginRight: 8 }} />
        Dashboard
      </Title>
      <Paragraph type="secondary" style={{ fontSize: 16, marginBottom: 24 }}>
        Analytics overview across all your agent graphs.
      </Paragraph>

      {error && (
        <Alert
          type="error"
          showIcon
          message="Failed to load analytics"
          description={error}
          style={{ marginBottom: 24 }}
        />
      )}

      {showEmptyState && (
        <Empty
          description="No analytics data yet. Run some agent graphs to see usage statistics here."
          style={{ margin: '60px 0' }}
        />
      )}

      {overview && !showEmptyState && (
        <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
          <Col xs={24} sm={12} lg={8} xl={6}>
            <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
              <Statistic
                title="Total Threads"
                value={overview.totalThreads}
                prefix={<MessageOutlined style={{ color: '#1677ff' }} />}
                valueStyle={{ color: '#1677ff' }}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} lg={8} xl={6}>
            <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
              <Statistic
                title="Total Tokens"
                value={overview.totalTokens}
                prefix={<ThunderboltOutlined style={{ color: '#722ed1' }} />}
                valueStyle={{ color: '#722ed1' }}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} lg={8} xl={6}>
            <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
              <Statistic
                title="Total Cost"
                value={formatUsd(overview.totalPrice)}
                prefix={<DollarOutlined style={{ color: '#52c41a' }} />}
                valueStyle={{ color: '#52c41a' }}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} lg={8} xl={6}>
            <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
              <Statistic
                title="Input Tokens"
                value={overview.inputTokens}
                prefix={<LoginOutlined style={{ color: '#13c2c2' }} />}
                valueStyle={{ color: '#13c2c2' }}
              />
            </Card>
          </Col>
          <Col xs={24} sm={12} lg={8} xl={6}>
            <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
              <Statistic
                title="Output Tokens"
                value={overview.outputTokens}
                prefix={<LogoutOutlined style={{ color: '#fa8c16' }} />}
                valueStyle={{ color: '#fa8c16' }}
              />
            </Card>
          </Col>
          {overview.cachedInputTokens > 0 && (
            <Col xs={24} sm={12} lg={8} xl={6}>
              <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
                <Statistic
                  title="Cached Input"
                  value={overview.cachedInputTokens}
                  prefix={<DatabaseOutlined style={{ color: '#eb2f96' }} />}
                  valueStyle={{ color: '#eb2f96' }}
                />
              </Card>
            </Col>
          )}
          {overview.reasoningTokens > 0 && (
            <Col xs={24} sm={12} lg={8} xl={6}>
              <Card hoverable styles={{ body: { padding: '20px 24px' } }}>
                <Statistic
                  title="Reasoning Tokens"
                  value={overview.reasoningTokens}
                  prefix={<BulbOutlined style={{ color: '#faad14' }} />}
                  valueStyle={{ color: '#faad14' }}
                />
              </Card>
            </Col>
          )}
        </Row>
      )}

      {hasGraphData && (
        <>
          <Title level={4} style={{ marginBottom: 16 }}>
            <BarChartOutlined style={{ marginRight: 8, color: '#8c8c8c' }} />
            Usage by Graph
          </Title>
          <Row gutter={[16, 16]}>
            {byGraph.graphs.map((graph) => (
              <Col xs={24} sm={12} xl={8} key={graph.graphId}>
                <GraphCard graph={graph} />
              </Col>
            ))}
          </Row>
        </>
      )}
    </div>
  );
};
