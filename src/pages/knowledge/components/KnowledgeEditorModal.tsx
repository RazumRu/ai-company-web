import '@uiw/react-md-editor/markdown-editor.css';

import MDEditor from '@uiw/react-md-editor';
import type { FormInstance } from 'antd';
import { Button, Form, Input, Modal, Select, Space, Typography } from 'antd';

import type { KnowledgeDocDto } from '../../../autogenerated';

export type KnowledgeFormValues = {
  title: string;
  tags?: string[];
  politic?: string;
};

type KnowledgeEditorModalProps = {
  open: boolean;
  activeDoc: KnowledgeDocDto | null;
  saving: boolean;
  form: FormInstance<KnowledgeFormValues>;
  editorValue: string;
  onEditorChange: (nextValue: string) => void;
  tagOptions: string[];
  onCancel: () => void;
  onSubmit: () => void;
  onOpenAiSuggestion: () => void;
  aiActionLabel: string;
};

const { Text } = Typography;

const ALWAYS_FETCH_FULL_CONTENT =
  'If this document is relevant to the current task - always fetch the full content instead of fetching only specific chunks.';

export const KnowledgeEditorModal = ({
  open,
  activeDoc,
  saving,
  form,
  editorValue,
  onEditorChange,
  tagOptions,
  onCancel,
  onSubmit,
  onOpenAiSuggestion,
  aiActionLabel,
}: KnowledgeEditorModalProps) => {
  return (
    <Modal
      title={activeDoc ? 'Edit knowledge' : 'Create knowledge'}
      open={open}
      onCancel={onCancel}
      onOk={onSubmit}
      okText={activeDoc ? 'Save' : 'Create'}
      okButtonProps={{ loading: saving }}
      destroyOnClose
      width={900}>
      <Form layout="vertical" form={form}>
        <Form.Item
          name="title"
          label="Title"
          rules={[{ required: true, message: 'Title is required' }]}>
          <Input placeholder="Knowledge title" />
        </Form.Item>
        <Form.Item
          name="politic"
          label="Politic"
          extra={
            <Space direction="vertical" size={0}>
              <Text type="secondary" style={{ fontSize: 12 }}>
                Notes for the LLM explaining when and what it should fetch from
                this document.
              </Text>
              <Button
                type="link"
                size="small"
                style={{ padding: 0, height: 'auto', fontSize: 11 }}
                onClick={() =>
                  form.setFieldsValue({
                    politic: ALWAYS_FETCH_FULL_CONTENT,
                  })
                }>
                Always fetch full content
              </Button>
            </Space>
          }>
          <Input.TextArea
            placeholder="Add LLM guidance"
            autoSize={{ minRows: 2, maxRows: 4 }}
          />
        </Form.Item>
        <Form.Item
          label={
            <Space align="center">
              <span>Content</span>
              <Button
                type="link"
                size="small"
                style={{ padding: 0, height: 'auto', fontSize: 12 }}
                onClick={onOpenAiSuggestion}>
                {aiActionLabel}
              </Button>
            </Space>
          }>
          <div data-color-mode="light">
            <MDEditor
              value={editorValue}
              onChange={(value) => onEditorChange(value || '')}
              height={320}
              preview="live"
            />
          </div>
        </Form.Item>
        <Form.Item name="tags" label="Tags">
          <Select
            mode="tags"
            placeholder="Add tags"
            options={tagOptions.map((tag) => ({ label: tag, value: tag }))}
            tokenSeparators={[',']}
          />
        </Form.Item>
      </Form>
    </Modal>
  );
};
