import type { GraphDto, TemplateDto } from '../autogenerated';

export interface TriggerNodeInfo {
  id: string;
  name: string;
  template: string;
}

export const buildTriggerNodes = (
  graph: GraphDto,
  templates: Record<string, TemplateDto>,
): TriggerNodeInfo[] => {
  const metadataNodes =
    graph.metadata?.nodes?.reduce<Record<string, string>>((acc, node) => {
      if (node.id) {
        acc[node.id] = node.name ?? '';
      }
      return acc;
    }, {}) ?? {};

  const nodes = graph.schema?.nodes ?? [];
  return nodes
    .filter((node) => {
      const template = templates[node.template];
      return (template?.kind ?? '').toLowerCase() === 'trigger';
    })
    .map((node) => {
      const template = templates[node.template];
      return {
        id: node.id,
        name: metadataNodes[node.id] || template?.name || node.template,
        template: node.template,
      };
    });
};

export const buildNodeDisplayNames = (
  graph: GraphDto,
): Record<string, string> => {
  const metadataNodes = graph.metadata?.nodes ?? [];
  return metadataNodes.reduce<Record<string, string>>((acc, node) => {
    if (!node.id) {
      return acc;
    }
    const metadataName = node.name?.trim();
    if (metadataName && metadataName.length > 0) {
      acc[node.id] = metadataName;
    }
    return acc;
  }, {});
};

export const extractThreadSubId = (
  externalThreadId?: string | null,
): string | undefined => {
  if (!externalThreadId) return undefined;
  const parts = externalThreadId.split(':');
  return parts[parts.length - 1];
};
