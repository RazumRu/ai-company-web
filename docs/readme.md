AI Company Web — Development Guidelines

This document captures project-specific knowledge to speed up onboarding and day‑to‑day work for advanced contributors. It focuses on details unique to this repository, not generic React/Vite advice.

Build and Configuration

- Runtime/tooling
  - Node: >= 22 (enforced via `engines.node`).
  - Package manager: pnpm (repo pins an exact pnpm in `package.json -> packageManager`).
  - Framework/tooling: React 18 + Vite, Refine (`@refinedev`) for app shell, routing, and build/start helpers.

- Key commands (all are pnpm scripts)
  - `pnpm dev` → `pnpm refine dev --port 5174`. Vite dev server binds to `0.0.0.0` (see `vite.config.ts`).
  - `pnpm build` → Type-check (`tsc`) then `pnpm refine build` to emit `dist/`.
  - `pnpm start` → `pnpm refine start` to preview the built bundle.
  - `pnpm generate:api` → Regenerate the OpenAPI TypeScript client. Requires `SWAGGER_URL` env to point to the backend Swagger JSON.

- Environment configuration
  - App configuration is code-driven in `src/config/` and selected by `import.meta.env.MODE`:
    - `src/config/development.ts` is used in dev
    - `src/config/production.ts` is used in production
  - Keys of interest exported via `src/config/index.ts`:
    - `API_URL`: REST + WebSocket base URL (dev default `http://localhost:5000`).
    - `KEYCLOAK_URL`, `KEYCLOAK_REALM`, `KEYCLOAK_CLIENT_ID`: SSO integration (dev default `http://localhost:8082`, realm `ai-company`, client `ai-company`).
    - `PROJECT_ID`, `WEBSITE_URL`: app metadata and base site URL.
  - Notes:
    - Vite dev server is network-exposed (host `0.0.0.0`). In containerized or remote dev, ensure the host/ports are reachable and align CORS accordingly on the API and Keycloak.
    - If your deployment pipeline injects env at runtime, mirror those into the `production.ts` module during build or add a lightweight bootstrapping step that maps env to these constants.

Authentication and API

- Keycloak integration lives in `src/auth.tsx` and `src/index.tsx` via `@react-keycloak/web`.
  - Tokens (and `tokenParsed`) are consumed by hooks and passed to data/WebSocket layers. When debugging auth issues, log or inspect `keycloak.token` and expiry/refresh flows.
- REST/OpenAPI client under `src/autogenerated/` is produced by `openapi-generator-cli` (`typescript-axios`). Regenerate it when backend endpoints change:
  - `SWAGGER_URL=http://localhost:5000/swagger-api-json pnpm generate:api`
  - If the backend requires auth to fetch the spec, pre-download the JSON and pass a `file://` URL, or expose a public spec endpoint in dev.

Realtime and Graph Studio specifics

- Socket.io client (`socket.io-client`) is used; see `src/hooks/useWebSocket.ts` for how auth headers and graph/thread subscriptions are set up. If websocket connections fail in dev:
  - Confirm `API_URL` scheme and host; use `ws(s)://` mapping consistent with `http(s)://` origin.
  - Check Keycloak CORS and web origin settings for both REST and WebSocket endpoints.
- The graph canvas and node editor are driven by `@xyflow/react` and JSON Schema‑backed forms. Layout/viewport persistence is handled by a `GraphStorageService` (local storage). When troubleshooting node rendering/connectivity:
  - Validate that templates’ schema and connection rules are in sync with what the backend expects.
  - Ensure autosave/restore isn’t re-applying stale layout by clearing the relevant local storage keys.

Code Style, Linting, and Formatting

- TypeScript is strict (`tsconfig.json`): `strict: true`, `noEmit`, ESM modules.
- ESLint configuration in `.eslintrc.cjs` extends `eslint:recommended`, `@typescript-eslint/recommended`, and `react-hooks/recommended`; React Refresh rule is enabled.
- Prettier is used for formatting.
- Helpful commands:
  - `pnpm lint:fix` → runs Prettier write across the repo, then ESLint with `--fix` on `src/**/*.{js,ts,tsx}`.


Release and Dependencies

- Semantic Release is configured (`release.config.cjs`). Use conventional commits to enable automated versioning and changelog generation.
- Use `pnpm up-versions` to perform dependency upgrades via `scripts/up-versions.sh`. Validate the app with dev and a production preview (`pnpm start`) after upgrades, since `@refinedev` and `@xyflow/react` minor bumps can include type or behavior changes.

Common Debugging Tips

- If login loops or silent failures occur:
  - Confirm `KEYCLOAK_URL/REALM/CLIENT_ID` and that the Keycloak client has Web Origins set to your dev server URL (`http://localhost:5174`) and any preview host you use.
- If WebSocket updates don’t appear:
  - Verify the token is attached; log from `useWebSocket` and ensure the backend accepts the header or query token format.
- If OpenAPI types don’t match actual responses:
  - Refresh the generated client and re-run type-checks: `pnpm generate:api && pnpm tsc`.
