# Geniro.io — AI Agent Graph Platform — Claude Code Guide

## Project Overview

This is the front-end workspace for an AI agent graph platform that enables building, running, and managing AI agent automations through a visual interface. The application provides a drag-and-drop canvas for orchestrating agent workflows, real-time execution monitoring, and a threaded chat interface for human-in-the-loop interactions.

**Tech Stack:** React 18 + Vite, Refine framework, Ant Design, TypeScript, Socket.io, @xyflow/react

## Key Architecture Patterns

### Authentication

- **Keycloak SSO** via `@react-keycloak/web`
- Tokens propagate to both Axios REST calls and WebSocket connections
- Project-scoped access control

### Data Layer

- **Auto-generated API clients** from OpenAPI spec (see `src/autogenerated/`)
- REST endpoints for CRUD operations
- WebSocket subscriptions for real-time updates
- Run `pnpm generate:api` to regenerate after backend changes

### State Management

- **Refine core** handles data fetching, routing, and CRUD
- **GraphStorageService** (`src/services/graphStorageService.ts`) provides local persistence for canvas viewport and layout
- **WebSocketService** (`src/services/websocketService.ts`) multiplexes graph subscriptions and event streams
- React hooks in `src/hooks/useWebSocket.ts` wrap socket listeners

### Real-time Updates

Socket.io streams:

- Graph compilation/deployment status
- Node execution state changes
- Agent message tokens (including streaming/partial)
- Revision lifecycle events
- Thread mutations

## Directory Structure

```
src/
├── autogenerated/        # OpenAPI-generated REST client (DO NOT EDIT MANUALLY)
├── components/          # Shared layout components (Header, Sidebar)
├── config/             # Environment configs (development.ts, production.ts)
├── hooks/              # useWebSocket and other React hooks
├── pages/
│   ├── graphs/         # Graph list, canvas, node editor, template sidebar, revision UI
│   └── chats/          # Thread directory and chat panel
├── services/           # WebSocketService, GraphStorageService, validation helpers
└── utils/              # Thread utilities, validation helpers
```

## Core Features & File Locations

### Graph Canvas

- **Canvas component:** `src/pages/graphs/components/GraphCanvas.tsx`
- **Node renderer:** `src/pages/graphs/components/CustomNode.tsx`
- **Template sidebar:** `src/pages/graphs/components/TemplateSidebar.tsx`
- Powered by `@xyflow/react` with snap-to-grid, zoom/pan, autosave

### Node Configuration

- **Node editor sidebar:** `src/pages/graphs/components/NodeEditSidebar.tsx`
- JSON-schema driven forms via `@rjsf/antd`
- Live metadata and execution transcripts

### Conversation Hub

- **Chat list page:** `src/pages/chats/`
- **Thread messages view:** `src/pages/graphs/components/ThreadMessagesView.tsx`
- Supports streaming tokens, message history, trigger selection

### Revision Management

- **Revision history:** `src/pages/graphs/components/RevisionHistory.tsx`
- Diff viewer shows added/removed nodes
- Status tracking: pending → applying → applied/failed

## Common Tasks

### Regenerate API Client

```bash
# Backend must be running at SWAGGER_URL
SWAGGER_URL=http://localhost:5000/swagger-api-json ./scripts/generate-api.sh
pnpm run lint:fix
```

### Run Development Server

```bash
pnpm dev  # Starts on port 5174
```

### Build for Production

```bash
pnpm build  # Outputs to dist/
pnpm start  # Preview production build
```

### Update Dependencies

```bash
./scripts/up-versions.sh
```

### Validate Changes

**IMPORTANT:** Always run full-check after making code changes to ensure TypeScript compilation and linting pass:

```bash
pnpm run full-check
```

This command:

1. Builds the project for production (catches TypeScript errors)
2. Runs ESLint with auto-fix (catches code quality issues)

Run this before committing changes or requesting code review.

## Configuration

Edit `src/config/development.ts` or `src/config/production.ts`:

| Key                  | Purpose                    | Default (dev)           |
| -------------------- | -------------------------- | ----------------------- |
| `API_URL`            | REST + WebSocket base URL  | `http://localhost:5000` |
| `KEYCLOAK_URL`       | SSO endpoint               | `http://localhost:8082` |
| `KEYCLOAK_REALM`     | Keycloak realm name        | `geniro`            |
| `KEYCLOAK_CLIENT_ID` | OAuth client ID            | `geniro`            |
| `PROJECT_ID`         | Refine devtools identifier | `oA2Grn-tb5EdO-q4j17C`  |
| `WEBSITE_URL`        | Client base URL            | `http://localhost:3004` |

## WebSocket Events

The `WebSocketService` handles these event types:

- `graphUpdate` - Graph status changes (Running/Stopped/Error)
- `graphCompile` - Compilation progress
- `revisionUpdate` - Revision lifecycle
- `nodeStateUpdate` - Node execution state
- `threadMessage` - Agent messages (including streaming tokens)
- `threadUpdate` - Thread metadata changes

Subscribe via hooks: `useWebSocket`, `useGraphWebSocket`, `useThreadWebSocket`

## Validation & Business Rules

- **Template compatibility:** `src/services/validationService.ts` validates trigger→agent→tool wiring
- **Connection rules:** Enforces required inputs, compatible node types
- **Graph status:** Only stopped graphs can be edited; running graphs are read-only

## Development Conventions

### Styling

- Ant Design components with custom theming
- CSS-in-JS via Ant Design's `styled` API
- Consistent spacing/colors from Ant Design tokens

### Code Organization

- Feature-based structure under `src/pages/`
- Shared services in `src/services/`
- Utility functions in `src/utils/`
- Types exported from autogenerated client

### API Integration

- Import API client from `src/autogenerated/api`
- Use Refine's `useList`, `useOne`, `useCreate`, etc. for CRUD
- Always regenerate API client after backend schema changes

## Known Patterns

### Adding a New Graph Node Type

1. Backend defines new template schema
2. Run `pnpm generate:api` to update types
3. Update `CustomNode.tsx` if special rendering needed
4. Add validation rules in `validationService.ts`

### Adding Real-time Event Handling

1. Define event handler in `WebSocketService`
2. Create hook in `useWebSocket.ts`
3. Subscribe in component with `useEffect`
4. Clean up subscription on unmount

### Modifying Canvas Behavior

- Edit `GraphCanvas.tsx` for layout/interaction
- Update `GraphStorageService` for persistence
- Ensure viewport state syncs with backend

## Testing & Debugging

### Browser DevTools

- React DevTools for component hierarchy
- Network tab for REST/WebSocket traffic
- Console for validation errors

### Common Issues

- **WebSocket not connecting:** Check KEYCLOAK token and API_URL
- **Canvas not saving:** Verify GraphStorageService localStorage access
- **API types out of sync:** Run `pnpm generate:api`

## Deployment

### Docker

```bash
docker build -t geniro-web .
docker run -p 80:80 geniro-web
```

### Environment Variables

Inject at build time via Vite:

```bash
VITE_API_URL=https://api.example.com pnpm build
```

## Contributing

1. Keep UI focused on graph authoring, execution monitoring, and operator collaboration
2. Regenerate API client after backend endpoint changes
3. Document new WebSocket events in this file
4. Follow existing code organization patterns

## Resources

- **Backend API:** Assumes REST + WebSocket at `API_URL`
- **Keycloak:** SSO realm configuration required
- **Refine docs:** https://refine.dev/docs/
- **xyflow docs:** https://xyflow.com/docs/

---

**Version:** 0.1.0
**Node requirement:** >=22
**Package manager:** pnpm@10.12.1
